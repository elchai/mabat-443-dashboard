<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>מבט 443 | פלטפורמת מודיעין גזרתית</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* ═══════════════════════════════════════
   MABAT 443 - CYBER DEFENSE DASHBOARD
   Futuristic Military Intelligence UI v2
   ═══════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

:root {
    --bg-primary: #040810;
    --bg-secondary: #0a1020;
    --bg-panel: rgba(8, 16, 35, 0.85);
    --bg-card: rgba(12, 22, 45, 0.9);
    --border-primary: #0f3460;
    --border-glow: #00d4ff;
    --cyan: #00d4ff;
    --cyan-dim: #00d4ff44;
    --green: #00ff88;
    --green-dim: #00ff8844;
    --red: #ff0040;
    --red-dim: #ff004044;
    --orange: #ff8800;
    --orange-dim: #ff880044;
    --yellow: #ffd000;
    --yellow-dim: #ffd00044;
    --blue: #4488ff;
    --purple: #a855f7;
    --purple-dim: #a855f744;
    --text-primary: #e0e8f0;
    --text-secondary: #7088a0;
    --text-dim: #3a4a5c;
    --font-display: 'Orbitron', monospace;
    --font-body: 'Rajdhani', sans-serif;
    --font-mono: 'Share Tech Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    overflow: hidden;
    height: 100vh;
    width: 100vw;
}

/* ═══════ ANIMATED BACKGROUND ═══════ */
.bg-grid {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: 0;
    animation: gridPulse 4s ease-in-out infinite;
}

@keyframes gridPulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.scan-line {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    z-index: 1000;
    animation: scanDown 4s linear infinite;
    opacity: 0.4;
    box-shadow: 0 0 20px var(--cyan), 0 0 60px var(--cyan-dim);
}

@keyframes scanDown {
    0% { top: -3px; }
    100% { top: 100vh; }
}

/* ═══════ CORNER DECORATIONS ═══════ */
.corner-decor {
    position: fixed;
    width: 60px;
    height: 60px;
    z-index: 5;
    pointer-events: none;
}
.corner-decor::before, .corner-decor::after {
    content: '';
    position: absolute;
    background: var(--cyan);
    box-shadow: 0 0 10px var(--cyan);
}
.corner-tl { top: 10px; left: 10px; }
.corner-tl::before { width: 30px; height: 2px; top: 0; left: 0; }
.corner-tl::after { width: 2px; height: 30px; top: 0; left: 0; }
.corner-tr { top: 10px; right: 10px; }
.corner-tr::before { width: 30px; height: 2px; top: 0; right: 0; }
.corner-tr::after { width: 2px; height: 30px; top: 0; right: 0; }
.corner-bl { bottom: 10px; left: 10px; }
.corner-bl::before { width: 30px; height: 2px; bottom: 0; left: 0; }
.corner-bl::after { width: 2px; height: 30px; bottom: 0; left: 0; }
.corner-br { bottom: 10px; right: 10px; }
.corner-br::before { width: 30px; height: 2px; bottom: 0; right: 0; }
.corner-br::after { width: 2px; height: 30px; bottom: 0; right: 0; }

/* ═══════ MAIN LAYOUT ═══════ */
.dashboard {
    display: grid;
    grid-template-rows: 70px 1fr 280px;
    grid-template-columns: 280px 1fr 320px;
    height: 100vh;
    gap: 2px;
    padding: 8px;
    position: relative;
    z-index: 2;
}

/* ═══════ HEADER ═══════ */
.header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.08), transparent);
    border-bottom: 1px solid var(--border-primary);
    position: relative;
}

.header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    box-shadow: 0 0 15px var(--cyan-dim);
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-hex {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, var(--cyan), var(--blue));
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: hexPulse 3s ease-in-out infinite;
    position: relative;
}

.logo-hex::before {
    content: '\2B21';
    font-size: 20px;
    color: var(--bg-primary);
    font-weight: bold;
}

@keyframes hexPulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.4) drop-shadow(0 0 10px var(--cyan)); }
}

.system-title {
    font-family: var(--font-display);
    font-weight: 900;
    font-size: 22px;
    letter-spacing: 4px;
    background: linear-gradient(90deg, var(--cyan), #fff, var(--cyan));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
    0% { background-position: 200% center; }
    100% { background-position: -200% center; }
}

.system-subtitle {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    letter-spacing: 2px;
}

.header-center {
    display: flex;
    align-items: center;
    gap: 15px;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 12px;
}

.header-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--cyan);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 1px;
}

.header-btn:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--cyan);
    box-shadow: 0 0 15px var(--cyan-dim);
}

.header-btn .btn-icon {
    font-size: 14px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 10px var(--green);
    animation: dotPulse 2s ease-in-out infinite;
}

.status-dot.offline {
    background: var(--red);
    box-shadow: 0 0 10px var(--red);
}

@keyframes dotPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
    font-family: var(--font-mono);
}

.clock {
    font-size: 20px;
    letter-spacing: 2px;
    color: var(--cyan);
    text-shadow: 0 0 10px var(--cyan-dim);
}

.date-display {
    font-size: 11px;
    color: var(--text-secondary);
}

/* ═══════ PANELS ═══════ */
.panel {
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border-glow), transparent);
    opacity: 0.5;
    z-index: 1;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 212, 255, 0.03);
}

.panel-title {
    font-family: var(--font-display);
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--cyan);
}

.panel-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: dotPulse 2s ease-in-out infinite;
}

.panel-body {
    padding: 12px;
    overflow-y: auto;
    height: calc(100% - 42px);
}

.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.panel-body::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 2px; }
.panel-body::-webkit-scrollbar-thumb:hover { background: var(--cyan-dim); }

/* ═══════ LEFT PANEL ═══════ */
.left-panel {
    grid-row: 2 / 4;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* Threat Level */
.threat-container { flex: 0 0 200px; }

.threat-gauge {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    gap: 10px;
}

.threat-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid var(--border-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    position: relative;
    transition: all 0.5s ease;
}

.threat-circle::before {
    content: '';
    position: absolute;
    inset: -8px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-top-color: var(--cyan);
    animation: rotate 3s linear infinite;
}

.threat-circle::after {
    content: '';
    position: absolute;
    inset: -14px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-bottom-color: var(--cyan-dim);
    animation: rotate 5s linear infinite reverse;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.threat-circle.level-gray { border-color: #666; }
.threat-circle.level-blue { border-color: var(--blue); box-shadow: 0 0 30px rgba(68, 136, 255, 0.2); }
.threat-circle.level-yellow { border-color: var(--yellow); box-shadow: 0 0 30px rgba(255, 208, 0, 0.2); }
.threat-circle.level-orange { border-color: var(--orange); box-shadow: 0 0 30px rgba(255, 136, 0, 0.3); }
.threat-circle.level-red { border-color: var(--red); box-shadow: 0 0 40px rgba(255, 0, 64, 0.4); animation: threatPulse 1.5s ease-in-out infinite; }

@keyframes threatPulse {
    0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 64, 0.3); }
    50% { box-shadow: 0 0 60px rgba(255, 0, 64, 0.6); }
}

.threat-level-num {
    font-family: var(--font-display);
    font-size: 36px;
    font-weight: 900;
    line-height: 1;
}

.threat-level-label {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 2px;
}

.threat-bars {
    display: flex;
    gap: 4px;
    width: 100%;
    height: 6px;
}

.threat-bar {
    flex: 1;
    border-radius: 2px;
    background: var(--bg-primary);
    transition: all 0.3s ease;
}

/* Stats */
.stats-container { flex: 1; }

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(15, 52, 96, 0.4);
}

.stat-label {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
}

.stat-value {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 700;
    color: var(--cyan);
}

.stat-value.red { color: var(--red); }
.stat-value.orange { color: var(--orange); }
.stat-value.yellow { color: var(--yellow); }
.stat-value.green { color: var(--green); }

/* Sources */
.sources-container { flex: 0 0 auto; }

.source-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    font-family: var(--font-mono);
    font-size: 11px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
}

.source-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
}

.source-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
.source-dot.inactive { background: #444; }

.source-name {
    flex: 1;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.source-type {
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 2px;
    border: 1px solid var(--border-primary);
}

.source-type.local { color: var(--green); border-color: var(--green-dim); }
.source-type.regional { color: var(--orange); border-color: var(--orange-dim); }
.source-type.national { color: var(--cyan); border-color: var(--cyan-dim); }
.source-type.news { color: var(--yellow); border-color: var(--yellow-dim); }

.source-count {
    color: var(--cyan);
    font-size: 10px;
}

/* ═══════ CENTER - MAP ═══════ */
.map-panel { position: relative; transition: all 0.4s ease; }

.map-panel.fullscreen {
    position: fixed !important;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9000;
    border-radius: 0;
    grid-row: auto;
    grid-column: auto;
}

#map {
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
}

.leaflet-container {
    background: var(--bg-primary) !important;
    font-family: var(--font-mono) !important;
}

.map-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 1000;
    border: 1px solid var(--border-primary);
    box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.5);
}

.map-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: repeating-linear-gradient(90deg, transparent, transparent 4px, var(--cyan-dim) 4px, var(--cyan-dim) 5px);
}

.map-coords {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    z-index: 1001;
    pointer-events: none;
}

.map-label {
    position: absolute;
    top: 10px;
    right: 10px;
    font-family: var(--font-display);
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--cyan);
    z-index: 1001;
    pointer-events: none;
    text-shadow: 0 0 10px var(--cyan-dim);
}

.map-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1001;
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    color: var(--cyan);
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 12px;
    transition: all 0.3s ease;
}

.map-btn:hover {
    background: rgba(0, 212, 255, 0.15);
    border-color: var(--cyan);
    box-shadow: 0 0 10px var(--cyan-dim);
}

/* ═══════ RIGHT PANEL - AI SUMMARY ═══════ */
.right-panel {
    grid-row: 2 / 3;
    display: flex;
    flex-direction: column;
}

.summary-text {
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-primary);
    direction: rtl;
    white-space: pre-wrap;
}

.summary-meta {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border-primary);
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    justify-content: space-between;
}

.ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 8px;
    border: 1px solid var(--cyan-dim);
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--cyan);
    letter-spacing: 1px;
}

.ai-badge::before {
    content: '\25C6';
    font-size: 6px;
    animation: dotPulse 1.5s ease-in-out infinite;
}

/* Config Panel */
.config-panel {
    grid-row: 3 / 4;
    grid-column: 3 / 4;
}

.config-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    font-family: var(--font-mono);
    font-size: 11px;
}

.config-key { color: var(--text-secondary); }
.config-val { color: var(--cyan); }

/* ═══════ BOTTOM - ALERT FEED ═══════ */
.alert-feed { grid-column: 2 / 3; display: flex; flex-direction: column; }

.alert-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.filter-chip {
    padding: 3px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    color: var(--text-dim);
    letter-spacing: 1px;
}

.filter-chip:hover { border-color: var(--cyan-dim); color: var(--text-secondary); }
.filter-chip.active { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 212, 255, 0.08); }
.filter-chip.active.red { border-color: var(--red); color: var(--red); background: var(--red-dim); }
.filter-chip.active.orange { border-color: var(--orange); color: var(--orange); background: var(--orange-dim); }
.filter-chip.active.yellow { border-color: var(--yellow); color: var(--yellow); background: var(--yellow-dim); }
.filter-chip.active.blue { border-color: var(--blue); color: var(--blue); background: rgba(68,136,255,0.12); }
.filter-chip.active.purple { border-color: var(--purple); color: var(--purple); background: var(--purple-dim); }

/* Anarchist toggle */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--purple);
    padding: 0 8px;
}

.toggle-switch {
    position: relative;
    width: 32px;
    height: 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-switch.active {
    background: var(--purple-dim);
    border-color: var(--purple);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: all 0.3s ease;
}

.toggle-switch.active::after {
    left: 18px;
    background: var(--purple);
    box-shadow: 0 0 6px var(--purple);
}

.search-input {
    flex: 1;
    max-width: 220px;
    padding: 4px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 11px;
    outline: none;
    direction: rtl;
    transition: border-color 0.3s ease;
}

.search-input::placeholder { color: var(--text-dim); }
.search-input:focus { border-color: var(--cyan); box-shadow: 0 0 8px var(--cyan-dim); }

.alert-feed .panel-body {
    padding: 0;
    flex: 1;
    overflow-y: auto;
}

.alert-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 15px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    transition: background 0.3s ease;
    direction: rtl;
    cursor: pointer;
}

.alert-item:hover { background: rgba(0, 212, 255, 0.03); }

.alert-item.expanded {
    background: rgba(0, 212, 255, 0.05);
    flex-direction: column;
    gap: 8px;
}

.alert-item.new-alert { animation: alertFlash 2s ease; }

@keyframes alertFlash {
    0% { background: rgba(0, 212, 255, 0.2); }
    100% { background: transparent; }
}

.alert-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    width: 100%;
}

.alert-time {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    white-space: nowrap;
    min-width: 45px;
    padding-top: 2px;
}

.alert-urgency {
    width: 8px; min-width: 8px; height: 8px;
    border-radius: 50%;
    margin-top: 5px;
    flex-shrink: 0;
}

.alert-urgency.urgency-5 { background: var(--red); box-shadow: 0 0 10px var(--red); animation: dotPulse 1s ease-in-out infinite; }
.alert-urgency.urgency-4 { background: var(--orange); box-shadow: 0 0 8px var(--orange); }
.alert-urgency.urgency-3 { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
.alert-urgency.urgency-2 { background: var(--blue); box-shadow: 0 0 6px var(--blue); }
.alert-urgency.urgency-1 { background: #666; }
.alert-urgency.urgency-anarchist { background: var(--purple); box-shadow: 0 0 8px var(--purple); }

.alert-content { flex: 1; min-width: 0; }

.alert-title {
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.alert-snippet {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.alert-full-text {
    font-family: var(--font-body);
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 8px 12px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.2);
    white-space: pre-wrap;
    direction: rtl;
}

.alert-meta-row {
    display: flex;
    gap: 10px;
    align-items: center;
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
}

.alert-source {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    white-space: nowrap;
    padding: 2px 6px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    margin-top: 2px;
}

/* ═══════ TIMELINE GRAPH ═══════ */
.timeline-graph {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.timeline-label {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    margin-bottom: 4px;
    letter-spacing: 1px;
}

.timeline-bars {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 35px;
}

.timeline-bar {
    flex: 1;
    min-width: 2px;
    background: var(--cyan-dim);
    border-radius: 1px 1px 0 0;
    transition: all 0.3s ease;
    position: relative;
}

.timeline-bar:hover {
    opacity: 0.8;
}

.timeline-bar.has-red { background: var(--red); box-shadow: 0 0 4px var(--red-dim); }
.timeline-bar.has-orange { background: var(--orange); }
.timeline-bar.has-yellow { background: var(--yellow); }
.timeline-bar.has-blue { background: var(--blue); }

.timeline-hours {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-mono);
    font-size: 8px;
    color: var(--text-dim);
    margin-top: 2px;
}

/* ═══════ HISTORY OVERLAY ═══════ */
.history-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(4, 8, 16, 0.95);
    z-index: 8000;
    display: none;
    flex-direction: column;
    animation: fadeIn 0.3s ease;
}

.history-overlay.visible {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 25px;
    border-bottom: 1px solid var(--border-primary);
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.06), transparent);
}

.history-title {
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 4px;
    color: var(--cyan);
}

.history-close {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 12px;
    transition: all 0.3s ease;
}

.history-close:hover {
    border-color: var(--red);
    color: var(--red);
}

.history-filters {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 25px;
    border-bottom: 1px solid var(--border-primary);
    flex-wrap: wrap;
}

.history-search {
    flex: 1;
    max-width: 300px;
    padding: 6px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 12px;
    outline: none;
    direction: rtl;
}

.history-search:focus { border-color: var(--cyan); }

.history-date-filter {
    padding: 5px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 11px;
}

.history-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px 25px;
}

.history-body::-webkit-scrollbar { width: 6px; }
.history-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.history-body::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; }

.history-date-group {
    margin-bottom: 20px;
}

.history-date-header {
    font-family: var(--font-display);
    font-size: 12px;
    letter-spacing: 2px;
    color: var(--cyan);
    padding: 8px 0;
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: 8px;
    position: sticky;
    top: 0;
    background: rgba(4, 8, 16, 0.95);
    z-index: 1;
}

.history-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.2);
    border-radius: 4px;
    transition: background 0.2s ease;
    direction: rtl;
}

.history-item:hover {
    background: rgba(0, 212, 255, 0.03);
}

.history-item-time {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
    min-width: 50px;
    padding-top: 2px;
}

.history-item-urgency {
    width: 10px; height: 10px;
    border-radius: 50%;
    margin-top: 4px;
    flex-shrink: 0;
}

.history-item-content {
    flex: 1;
}

.history-item-title {
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
}

.history-item-text {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.5;
}

.history-item-source {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
}

.history-stat-bar {
    display: flex;
    gap: 15px;
    padding: 10px 25px;
    border-bottom: 1px solid var(--border-primary);
    font-family: var(--font-mono);
    font-size: 12px;
}

.history-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
}

.history-stat strong {
    color: var(--cyan);
    font-family: var(--font-display);
}

/* ═══════ RED ALERT FLASH ═══════ */
.red-alert-flash {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
}

.red-alert-flash.active {
    animation: redFlash 3s ease-out;
}

@keyframes redFlash {
    0% { opacity: 1; background: rgba(255, 0, 64, 0.3); }
    10% { opacity: 0.8; background: rgba(255, 0, 64, 0.15); }
    20% { opacity: 1; background: rgba(255, 0, 64, 0.25); }
    30% { opacity: 0.5; background: rgba(255, 0, 64, 0.1); }
    100% { opacity: 0; }
}

/* ═══════ LOADING / EMPTY ═══════ */
.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 15px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
}

.loading-spinner {
    width: 40px; height: 40px;
    border: 2px solid var(--border-primary);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
    text-align: center;
    padding: 30px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
}

/* ═══════ REFRESH BAR ═══════ */
.refresh-bar {
    position: fixed;
    bottom: 0; left: 0;
    height: 2px;
    background: var(--cyan);
    z-index: 1001;
    transition: width 1s linear;
    box-shadow: 0 0 10px var(--cyan);
}

/* ═══════ URGENCY TAG ═══════ */
.urgency-tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1px;
    font-weight: 600;
}

.urgency-tag.red { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
.urgency-tag.orange { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange); }
.urgency-tag.yellow { background: var(--yellow-dim); color: var(--yellow); border: 1px solid var(--yellow); }
.urgency-tag.blue { background: rgba(68,136,255,0.15); color: var(--blue); border: 1px solid var(--blue); }

/* ═══════ RESPONSIVE ═══════ */
@media (max-width: 1200px) {
    .dashboard { grid-template-columns: 220px 1fr 260px; }
}

@media (max-width: 900px) {
    body { overflow-y: auto; overflow-x: hidden; }

    .dashboard {
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding: 4px;
        gap: 4px;
    }

    .header {
        flex-wrap: wrap;
        padding: 8px 12px;
        gap: 8px;
        min-height: 60px;
        height: auto;
    }

    .system-title { font-size: 16px; letter-spacing: 2px; }
    .system-subtitle { font-size: 9px; display: none; }
    .logo-hex { width: 35px; height: 35px; }
    .header-center { gap: 6px; flex-wrap: wrap; }
    .header-center .status-badge { padding: 3px 8px; font-size: 10px; }
    .header-right { display: none; }

    .map-panel {
        height: 45vh;
        min-height: 280px;
        order: 1;
    }

    .alert-feed {
        min-height: 300px;
        max-height: 50vh;
        order: 2;
    }

    .alert-toolbar { flex-wrap: wrap; gap: 4px; padding: 4px 8px; }
    .filter-chip { padding: 4px 8px; font-size: 9px; }
    .search-input { max-width: 100%; min-width: 120px; }

    .timeline-graph { padding: 4px 8px; }
    .timeline-bars { height: 25px; }

    .alert-item { padding: 8px 10px; gap: 8px; }
    .alert-title { font-size: 12px; }
    .alert-snippet { font-size: 9px; }
    .alert-source { font-size: 8px; padding: 1px 4px; }

    .left-panel {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        order: 3;
    }

    .threat-container {
        flex: 1 1 160px;
        max-width: 50%;
    }

    .threat-gauge { padding: 10px; }
    .threat-circle { width: 90px; height: 90px; }
    .threat-level-num { font-size: 28px; }

    .stats-container {
        flex: 1 1 160px;
        max-width: 50%;
    }

    .sources-container {
        flex: 1 1 100%;
    }

    .right-panel {
        order: 4;
        min-height: 200px;
    }

    .config-panel {
        order: 5;
    }

    .panel-title { font-size: 9px; letter-spacing: 2px; }
    .stat-label { font-size: 10px; }
    .stat-value { font-size: 14px; }

    .map-btn { font-size: 10px; padding: 4px 8px; }

    .history-header { padding: 10px 15px; }
    .history-title { font-size: 14px; }
    .history-filters { padding: 8px 15px; gap: 6px; }
    .history-body { padding: 10px 15px; }
    .history-item { padding: 8px; }
    .history-stat-bar { padding: 8px 15px; gap: 8px; font-size: 10px; flex-wrap: wrap; }

    .corner-decor { display: none; }
}

@media (max-width: 480px) {
    .header-center .status-badge:nth-child(2),
    .header-center .status-badge:nth-child(3) { display: none; }
    .header-btn { padding: 4px 8px; font-size: 10px; }
    .header-btn .btn-icon { font-size: 12px; }
    .logo-section { gap: 8px; }
    .map-panel { height: 35vh; min-height: 220px; }
    .threat-container, .stats-container { max-width: 100%; flex: 1 1 100%; }
    .alert-toolbar .toggle-container span:last-child { display: none; }
}

/* Dark tooltip */
.dark-tooltip {
    background: rgba(8, 16, 35, 0.95) !important;
    color: #e0e8f0 !important;
    border: 1px solid #0f3460 !important;
    border-radius: 4px !important;
    font-family: 'Share Tech Mono', monospace !important;
    font-size: 11px !important;
    padding: 6px 10px !important;
    box-shadow: 0 0 15px rgba(0, 212, 255, 0.2) !important;
}
.dark-tooltip::before { border-top-color: #0f3460 !important; }

.leaflet-popup-content-wrapper {
    background: rgba(8, 16, 35, 0.95) !important;
    color: #e0e8f0 !important;
    border: 1px solid #0f3460 !important;
    border-radius: 4px !important;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.2) !important;
}
.leaflet-popup-tip { background: rgba(8, 16, 35, 0.95) !important; }
</style>
</head>
<body>

<!-- Background Effects -->
<div class="bg-grid"></div>
<div class="scan-line"></div>
<div class="corner-decor corner-tl"></div>
<div class="corner-decor corner-tr"></div>
<div class="corner-decor corner-bl"></div>
<div class="corner-decor corner-br"></div>

<!-- Red Alert Flash -->
<div class="red-alert-flash" id="redAlertFlash"></div>

<!-- Dashboard Grid -->
<div class="dashboard" id="mainDashboard">

    <!-- HEADER -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-hex"></div>
            <div>
                <div class="system-title">MABAT 443</div>
                <div class="system-subtitle">SECTOR INTELLIGENCE PLATFORM</div>
            </div>
        </div>

        <div class="header-center">
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ONLINE</span>
            </div>
            <div class="status-badge">
                <span>SCAN</span>
                <span id="lastScan" style="color: var(--cyan);">--:--</span>
            </div>
            <div class="status-badge">
                <span>ALERTS</span>
                <span id="alertCount" style="color: var(--orange);">0</span>
            </div>
            <button class="header-btn" onclick="toggleHistory()">
                <span class="btn-icon">&#9776;</span>
                <span>HISTORY</span>
            </button>
        </div>

        <div class="header-right">
            <div>
                <div class="clock" id="clock">00:00:00</div>
                <div class="date-display" id="dateDisplay"></div>
            </div>
        </div>
    </header>

    <!-- LEFT PANEL -->
    <div class="left-panel">
        <div class="panel threat-container">
            <div class="panel-header">
                <span class="panel-title">THREAT LEVEL</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="threat-gauge">
                <div class="threat-circle level-gray" id="threatCircle">
                    <div class="threat-level-num" id="threatNum">0</div>
                    <div class="threat-level-label" id="threatLabel">CLEAR</div>
                </div>
                <div class="threat-bars" id="threatBars">
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                </div>
            </div>
        </div>

        <div class="panel stats-container">
            <div class="panel-header">
                <span class="panel-title">ANALYTICS</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="panel-body">
                <div class="stat-row">
                    <span class="stat-label">TOTAL</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">RED</span>
                    <span class="stat-value red" id="statRed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ORANGE</span>
                    <span class="stat-value orange" id="statOrange">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">YELLOW</span>
                    <span class="stat-value yellow" id="statYellow">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">BLUE</span>
                    <span class="stat-value" id="statBlue">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">SOURCES</span>
                    <span class="stat-value green" id="statSources">0</span>
                </div>
            </div>
        </div>

        <div class="panel sources-container">
            <div class="panel-header">
                <span class="panel-title">SOURCES</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="panel-body" id="sourcesList">
                <div class="loading-state"><div class="loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- CENTER - MAP -->
    <div class="panel map-panel" id="mapPanel">
        <div id="map"></div>
        <div class="map-overlay"></div>
        <div class="map-coords">31.870N  35.120E</div>
        <div class="map-label">SECTOR 443</div>
        <button class="map-btn" onclick="toggleMapFullscreen()" id="mapBtn" title="F = Fullscreen">&#x26F6; EXPAND</button>
    </div>

    <!-- RIGHT PANEL - AI SUMMARY -->
    <div class="panel right-panel">
        <div class="panel-header">
            <span class="panel-title">AI BRIEFING</span>
            <span class="ai-badge">GEMINI AI</span>
        </div>
        <div class="panel-body" id="summaryBody">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>AWAITING AI ANALYSIS...</span>
            </div>
        </div>
    </div>

    <!-- BOTTOM - ALERT FEED -->
    <div class="panel alert-feed" id="alertFeedPanel">
        <div class="panel-header">
            <span class="panel-title">LIVE FEED</span>
            <div style="display:flex; gap:8px; align-items:center;">
                <span class="urgency-tag red">RED</span>
                <span class="urgency-tag orange">HIGH</span>
                <span class="urgency-tag yellow">MED</span>
                <span class="urgency-tag blue">LOW</span>
            </div>
        </div>
        <div class="alert-toolbar">
            <button class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">ALL</button>
            <button class="filter-chip red" data-filter="5" onclick="setFilter(5, this)">RED</button>
            <button class="filter-chip orange" data-filter="4" onclick="setFilter(4, this)">ORANGE</button>
            <button class="filter-chip yellow" data-filter="3" onclick="setFilter(3, this)">YELLOW</button>
            <button class="filter-chip blue" data-filter="2" onclick="setFilter(2, this)">BLUE</button>
            <button class="filter-chip purple" data-filter="anarchist" onclick="setFilter('anarchist', this)">ANARCH</button>
            <div class="toggle-container">
                <div class="toggle-switch active" id="anarchistToggle" onclick="toggleAnarchist()"></div>
                <span>ACTIVISTS</span>
            </div>
            <input type="text" class="search-input" id="searchInput" placeholder="SEARCH..." oninput="applyFilters()">
        </div>
        <div class="timeline-graph">
            <div class="timeline-label">24H ACTIVITY</div>
            <div class="timeline-bars" id="timelineBars"></div>
            <div class="timeline-hours" id="timelineHours"></div>
        </div>
        <div class="panel-body" id="alertFeed">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>SCANNING...</span>
            </div>
        </div>
    </div>

    <!-- CONFIG PANEL -->
    <div class="panel config-panel">
        <div class="panel-header">
            <span class="panel-title">SYSTEM</span>
            <div class="panel-indicator"></div>
        </div>
        <div class="panel-body">
            <div class="config-item"><span class="config-key">SECTOR</span><span class="config-val">ROUTE 443</span></div>
            <div class="config-item"><span class="config-key">RADIUS</span><span class="config-val">15 KM</span></div>
            <div class="config-item"><span class="config-key">CENTER</span><span class="config-val">31.87N 35.12E</span></div>
            <div class="config-item"><span class="config-key">SCAN</span><span class="config-val">10 MIN</span></div>
            <div class="config-item"><span class="config-key">AI</span><span class="config-val">GEMINI 2.0</span></div>
            <div class="config-item"><span class="config-key">RETAIN</span><span class="config-val">72 HRS</span></div>
            <div class="config-item"><span class="config-key">REFRESH</span><span class="config-val" id="nextRefresh">30s</span></div>
        </div>
    </div>

</div>

<!-- HISTORY OVERLAY -->
<div class="history-overlay" id="historyOverlay">
    <div class="history-header">
        <div class="history-title">HISTORY LOG</div>
        <button class="history-close" onclick="toggleHistory()">ESC CLOSE</button>
    </div>
    <div class="history-stat-bar" id="historyStats"></div>
    <div class="history-filters">
        <input type="text" class="history-search" id="historySearch" placeholder="SEARCH HISTORY..." oninput="renderHistory()">
        <button class="filter-chip active" data-hfilter="all" onclick="setHistoryFilter('all', this)">ALL</button>
        <button class="filter-chip red" data-hfilter="5" onclick="setHistoryFilter(5, this)">RED</button>
        <button class="filter-chip orange" data-hfilter="4" onclick="setHistoryFilter(4, this)">ORANGE</button>
        <button class="filter-chip yellow" data-hfilter="3" onclick="setHistoryFilter(3, this)">YELLOW</button>
        <button class="filter-chip blue" data-hfilter="2" onclick="setHistoryFilter(2, this)">BLUE</button>
    </div>
    <div class="history-body" id="historyBody">
        <div class="loading-state"><div class="loading-spinner"></div><span>LOADING HISTORY...</span></div>
    </div>
</div>

<!-- Refresh Bar -->
<div class="refresh-bar" id="refreshBar"></div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ═══════════════════════════════════════
// MABAT 443 - DASHBOARD ENGINE v2
// ═══════════════════════════════════════

const FIREBASE_URL = 'https://project-8874611670473210078-default-rtdb.europe-west1.firebasedatabase.app';
const SECTOR_CENTER = { lat: 31.870, lng: 35.120 };
const REFRESH_INTERVAL = 30000;

// KEY VILLAGES - highlighted on map with larger markers
const KEY_VILLAGES = [
    { he: "בית סירא", lat: 31.848, lng: 35.075 },
    { he: "בית ליקיא", lat: 31.833, lng: 35.080 },
    { he: "ח'רבת אל-מיסבאח", lat: 31.852, lng: 35.098 },
    { he: "בית עור א-תחתא", lat: 31.870, lng: 35.120 },
    { he: "ספא", lat: 31.878, lng: 35.087 },
    { he: "מידיה", lat: 31.838, lng: 35.110 },
    { he: "בית דורס (בן דרוס)", lat: 31.825, lng: 35.095 },
    { he: "קיבא", lat: 31.810, lng: 35.090 },
    { he: "רנתיס", lat: 31.815, lng: 35.060 },
];

const P1_LOCATIONS = [
    { name: "Beit Ur al-Tahta", he: "בית עור א-תחתא", lat: 31.870, lng: 35.120 },
    { name: "Beit Ur al-Fauqa", he: "בית עור אל-פוקא", lat: 31.878, lng: 35.130 },
    { name: "Khirbet al-Misbah", he: "ח'רבת אל-מיסבאח", lat: 31.852, lng: 35.098 },
    { name: "Beit Horon", he: "בית חורון", lat: 31.860, lng: 35.148 },
    { name: "Midya", he: "מידיה", lat: 31.838, lng: 35.110 },
    { name: "Budrus", he: "בית דורס (בן דרוס)", lat: 31.825, lng: 35.095 },
    { name: "Qibya", he: "קיבא", lat: 31.810, lng: 35.090 },
    { name: "Rantis", he: "רנתיס", lat: 31.815, lng: 35.060 },
];

const P2_LOCATIONS = [
    { name: "Deir Ibzia", he: "דיר איביע", lat: 31.893, lng: 35.155 },
    { name: "Kafr Nimah", he: "כפר ניעמה", lat: 31.905, lng: 35.120 },
    { name: "Safa", he: "ספא", lat: 31.878, lng: 35.087 },
    { name: "Bilin", he: "בילעין", lat: 31.900, lng: 35.080 },
    { name: "Beit Sira", he: "בית סירא", lat: 31.848, lng: 35.075 },
    { name: "Beit Liqya", he: "בית ליקיא", lat: 31.833, lng: 35.080 },
    { name: "Ein Arik", he: "עין עריכ", lat: 31.895, lng: 35.175 },
    { name: "Ein Qiniya", he: "עין קיניא", lat: 31.905, lng: 35.195 },
    { name: "Tira", he: "טירה", lat: 31.845, lng: 35.155 },
];

const P3_LOCATIONS = [
    { name: "Route 443", he: "כביש 443", lat: 31.870, lng: 35.120 },
    { name: "Route 446", he: "כביש 446", lat: 31.920, lng: 35.070 },
    { name: "Maccabim CP", he: "מחסום מכבים", lat: 31.850, lng: 35.050 },
    { name: "Modi'in Illit", he: "מודיעין עילית", lat: 31.930, lng: 35.050 },
    { name: "Givat Zeev", he: "גבעת זאב", lat: 31.860, lng: 35.170 },
];

const SOURCES = [
    { id: 'deiribzi', name: 'דיר איביע', type: 'local' },
    { id: 'beit_liqya', name: 'בית ליקיא', type: 'local' },
    { id: 'beit_sira', name: 'בית סירא', type: 'local' },
    { id: 'ramallahnew', name: 'רמאללה חדשות', type: 'regional' },
    { id: 'ramallahmix1', name: 'רמאללה מיקס', type: 'regional' },
    { id: 'QudsN', name: 'רשת קודס', type: 'national' },
    { id: 'palinfo', name: 'מרכז תקשורת', type: 'national' },
    { id: 'PalestineResist', name: 'Resistance News', type: 'national' },
    { id: 'google-news', name: 'Google News', type: 'news' },
];

// ═══════ STATE ═══════
let map;
let alertMarkers = [];
let newsData = {};
let allNewsData = {};
let summaryData = null;
let metaData = null;
let activeFilter = 'all';
let historyFilter = 'all';
let knownIds = new Set();
let isFirstLoad = true;
let mapIsFullscreen = false;
let showAnarchists = true;

// Anarchist/activist keywords
const ANARCHIST_KEYWORDS = [
    'anarchist', 'activist', 'solidarity', 'protest',
    'ISM', 'B\'Tselem', 'breaking the silence',
    'international', 'demonstration', 'confrontation',
    'left-wing', 'peace now',
    'ناشط', 'ناشطين', 'تضامن', 'متظاهرين', 'اجانب',
    'اسرائيليين ضد', 'سلام الان',
    'פעיל', 'פעילי', 'אנרכיסט', 'אנרכיסטים',
    'שוברים שתיקה', 'בצלם', 'שמאל',
    'פעילי שמאל', 'מפגינים', 'סולידריות',
    'ISM', 'בינלאומיים', 'שלום עכשיו',
    'מחאה', 'הפגנה', 'פעילות מחאה',
];

// ═══════ CLOCK ═══════
function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('clock').textContent = `${h}:${m}:${s}`;

    const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const months = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
    document.getElementById('dateDisplay').textContent = `יום ${days[now.getDay()]} | ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
}

// ═══════ MAP ═══════
function initMap() {
    map = L.map('map', {
        center: [SECTOR_CENTER.lat, SECTOR_CENTER.lng],
        zoom: 12,
        zoomControl: false,
        attributionControl: false
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
    }).addTo(map);

    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 15000, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.03, weight: 1, dashArray: '8, 8', opacity: 0.3
    }).addTo(map);

    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 200, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.3, weight: 2
    }).addTo(map);

    P1_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 6, color: '#ff0040', fillColor: '#ff0040', fillOpacity: 0.4, weight: 1.5
        }).bindTooltip(`<b>P1</b> ${loc.he}`, { className: 'dark-tooltip' }).addTo(map);
    });

    P2_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 5, color: '#ff8800', fillColor: '#ff8800', fillOpacity: 0.3, weight: 1
        }).bindTooltip(`<b>P2</b> ${loc.he}`, { className: 'dark-tooltip' }).addTo(map);
    });

    P3_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 4, color: '#4488ff', fillColor: '#4488ff', fillOpacity: 0.3, weight: 1
        }).bindTooltip(`<b>P3</b> ${loc.he}`, { className: 'dark-tooltip' }).addTo(map);
    });

    // KEY VILLAGES - larger highlighted markers with pulse
    KEY_VILLAGES.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 8,
            color: '#ff0040',
            fillColor: '#ff0040',
            fillOpacity: 0.5,
            weight: 2
        }).bindTooltip(`<b style="color:#ff0040;">KEY</b> ${loc.he}`, { className: 'dark-tooltip', permanent: false }).addTo(map);
        // Outer pulse ring
        L.circleMarker([loc.lat, loc.lng], {
            radius: 14,
            color: '#ff0040',
            fillColor: 'transparent',
            fillOpacity: 0,
            weight: 1,
            opacity: 0.3,
            dashArray: '4,4'
        }).addTo(map);
    });

    const route443 = [
        [31.840, 35.040], [31.845, 35.055], [31.850, 35.070],
        [31.855, 35.085], [31.860, 35.095], [31.865, 35.108],
        [31.870, 35.120], [31.875, 35.135], [31.878, 35.148],
        [31.880, 35.160], [31.882, 35.175]
    ];
    L.polyline(route443, {
        color: '#00d4ff', weight: 2, opacity: 0.5, dashArray: '10, 6'
    }).addTo(map);
}

function toggleMapFullscreen() {
    const panel = document.getElementById('mapPanel');
    const btn = document.getElementById('mapBtn');
    mapIsFullscreen = !mapIsFullscreen;

    if (mapIsFullscreen) {
        panel.classList.add('fullscreen');
        btn.innerHTML = '&#x26F6; MINIMIZE';
    } else {
        panel.classList.remove('fullscreen');
        btn.innerHTML = '&#x26F6; EXPAND';
    }
    setTimeout(() => map.invalidateSize(), 400);
}

function updateMapMarkers(news) {
    alertMarkers.forEach(m => map.removeLayer(m));
    alertMarkers = [];

    Object.values(news).forEach(item => {
        if (!item.coordinates) return;
        const colors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#666' };
        const color = colors[item.urgency] || '#666';
        const size = item.urgency >= 4 ? 12 : item.urgency >= 3 ? 9 : 7;

        const marker = L.circleMarker(
            [item.coordinates.lat, item.coordinates.lon || item.coordinates.lng],
            { radius: size, color, fillColor: color, fillOpacity: 0.6, weight: 2 }
        ).bindPopup(`
            <div style="direction:rtl; font-family: 'Rajdhani', sans-serif; max-width: 250px;">
                <b style="color:${color};">[${item.urgencyLabel || 'ALERT'}]</b><br>
                <b>${escapeHtml(item.title || '')}</b><br>
                <small>${escapeHtml(item.snippet || '')}</small><br>
                <small style="color:#888;">${escapeHtml(item.source)} | ${formatTime(item.timestamp)}</small>
            </div>
        `, { className: 'dark-tooltip', maxWidth: 280 }).addTo(map);

        alertMarkers.push(marker);
    });
}

// ═══════ FETCH DATA ═══════
async function fetchData() {
    try {
        const [newsRes, summaryRes, metaRes] = await Promise.all([
            fetch(`${FIREBASE_URL}/news.json?orderBy="savedAt"&limitToLast=100`),
            fetch(`${FIREBASE_URL}/world-news-summary/current.json`),
            fetch(`${FIREBASE_URL}/metadata.json`)
        ]);

        const news = await newsRes.json();
        const summary = await summaryRes.json();
        const meta = await metaRes.json();

        // Detect new alerts for flash
        if (news && !isFirstLoad) {
            const newIds = Object.keys(news);
            let hasNewRed = false;
            newIds.forEach(id => {
                if (!knownIds.has(id) && news[id].urgency >= 5) hasNewRed = true;
            });
            if (hasNewRed) triggerRedAlert();
        }

        if (news) {
            newsData = news;
            allNewsData = { ...allNewsData, ...news };
            Object.keys(news).forEach(id => knownIds.add(id));
        }
        if (summary) summaryData = summary;
        if (meta) metaData = meta;

        isFirstLoad = false;
        document.getElementById('statusDot').className = 'status-dot';
        document.getElementById('statusText').textContent = 'ONLINE';
        renderAll();
    } catch (error) {
        console.error('Fetch error:', error);
        document.getElementById('statusDot').className = 'status-dot offline';
        document.getElementById('statusText').textContent = 'ERROR';
    }
}

// ═══════ RED ALERT ═══════
function triggerRedAlert() {
    const flash = document.getElementById('redAlertFlash');
    flash.classList.remove('active');
    void flash.offsetWidth; // reflow
    flash.classList.add('active');

    // Audio beep
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'square';
        gain.gain.value = 0.15;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
        osc.stop(ctx.currentTime + 0.5);
    } catch (e) {}
}

// ═══════ RENDER ALL ═══════
function renderAll() {
    renderAlerts();
    renderSummary();
    renderStats();
    renderSources();
    renderThreatLevel();
    renderMeta();
    renderTimeline();
    updateMapMarkers(newsData);
}

// ═══════ FILTERS ═══════
function setFilter(level, btn) {
    activeFilter = level;
    document.querySelectorAll('.alert-toolbar .filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderAlerts();
}

function applyFilters() {
    renderAlerts();
}

function toggleAnarchist() {
    showAnarchists = !showAnarchists;
    const toggle = document.getElementById('anarchistToggle');
    toggle.classList.toggle('active', showAnarchists);
    renderAlerts();
}

function isAnarchistEvent(item) {
    const text = ((item.title || '') + ' ' + (item.snippet || '') + ' ' + (item.fullText || '')).toLowerCase();
    return ANARCHIST_KEYWORDS.some(kw => text.includes(kw.toLowerCase()));
}

function setHistoryFilter(level, btn) {
    historyFilter = level;
    document.querySelectorAll('.history-filters .filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderHistory();
}

// ═══════ RENDER ALERTS ═══════
function renderAlerts() {
    const feed = document.getElementById('alertFeed');
    let items = Object.values(newsData);
    const searchText = (document.getElementById('searchInput').value || '').toLowerCase();

    // Tag anarchist events
    items.forEach(i => { i._isAnarchist = isAnarchistEvent(i); });

    // Filter by anarchist toggle
    if (!showAnarchists) {
        items = items.filter(i => !i._isAnarchist);
    }

    if (activeFilter === 'anarchist') {
        items = items.filter(i => i._isAnarchist);
    } else if (activeFilter !== 'all') {
        items = items.filter(i => i.urgency === activeFilter);
    }
    if (searchText) {
        items = items.filter(i =>
            (i.title || '').toLowerCase().includes(searchText) ||
            (i.snippet || '').toLowerCase().includes(searchText) ||
            (i.fullText || '').toLowerCase().includes(searchText) ||
            (i.source || '').toLowerCase().includes(searchText)
        );
    }

    if (items.length === 0) {
        feed.innerHTML = `<div class="empty-state">
            ${searchText || activeFilter !== 'all' ? 'NO MATCHING ALERTS' : 'NO ACTIVE THREATS'}<br>
            <small style="color: var(--green);">${searchText ? 'TRY DIFFERENT SEARCH' : 'SECTOR CLEAR'}</small>
        </div>`;
        return;
    }

    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    feed.innerHTML = items.map(item => `
        <div class="alert-item" onclick="toggleAlertExpand(this)">
            <div class="alert-row">
                <span class="alert-time">${formatTime(item.timestamp)}</span>
                <div class="alert-urgency ${item._isAnarchist ? 'urgency-anarchist' : 'urgency-' + (item.urgency || 1)}"></div>
                <div class="alert-content">
                    <div class="alert-title">${escapeHtml(item.title || 'N/A')}</div>
                    <div class="alert-snippet">${escapeHtml((item.snippet || item.fullText || '').substring(0, 120))}</div>
                </div>
                <span class="alert-source">${escapeHtml(item.source || 'N/A')}</span>
            </div>
            <div class="alert-full-text" style="display:none;">${escapeHtml(item.fullText || item.snippet || '')}</div>
            <div class="alert-meta-row" style="display:none;">
                <span>${formatDateTime(item.timestamp)}</span>
                ${item.matchedLocations ? '<span>LOC: ' + escapeHtml(item.matchedLocations.join(', ')) + '</span>' : ''}
                ${item.matchedKeywords ? '<span>KW: ' + escapeHtml(item.matchedKeywords.join(', ')) + '</span>' : ''}
                ${item.distance ? '<span>' + item.distance.toFixed(1) + ' km</span>' : ''}
            </div>
        </div>
    `).join('');
}

function toggleAlertExpand(el) {
    const fullText = el.querySelector('.alert-full-text');
    const metaRow = el.querySelector('.alert-meta-row');
    const isExpanded = el.classList.contains('expanded');

    // Close all others
    document.querySelectorAll('.alert-item.expanded').forEach(item => {
        if (item !== el) {
            item.classList.remove('expanded');
            item.querySelector('.alert-full-text').style.display = 'none';
            item.querySelector('.alert-meta-row').style.display = 'none';
        }
    });

    if (isExpanded) {
        el.classList.remove('expanded');
        fullText.style.display = 'none';
        metaRow.style.display = 'none';
    } else {
        el.classList.add('expanded');
        fullText.style.display = 'block';
        metaRow.style.display = 'flex';
    }
}

// ═══════ RENDER TIMELINE ═══════
function renderTimeline() {
    const container = document.getElementById('timelineBars');
    const hoursContainer = document.getElementById('timelineHours');
    const items = Object.values(newsData);
    const now = Date.now();
    const hours = 24;
    const buckets = Array.from({ length: hours }, () => ({ count: 0, maxUrg: 0 }));

    items.forEach(item => {
        const age = (now - (item.timestamp || 0)) / (1000 * 60 * 60);
        const bucket = Math.min(hours - 1, Math.max(0, Math.floor(age)));
        buckets[bucket].count++;
        buckets[bucket].maxUrg = Math.max(buckets[bucket].maxUrg, item.urgency || 1);
    });

    const maxCount = Math.max(1, ...buckets.map(b => b.count));

    // Reverse so newest is on the right
    const reversed = [...buckets].reverse();

    container.innerHTML = reversed.map((b, i) => {
        const h = Math.max(2, (b.count / maxCount) * 35);
        const urgClass = b.maxUrg >= 5 ? 'has-red' : b.maxUrg >= 4 ? 'has-orange' : b.maxUrg >= 3 ? 'has-yellow' : b.count > 0 ? 'has-blue' : '';
        return `<div class="timeline-bar ${urgClass}" style="height:${h}px;" title="${b.count} alerts"></div>`;
    }).join('');

    // Hour labels
    const nowHour = new Date().getHours();
    hoursContainer.innerHTML = '';
    for (let i = 0; i < hours; i += 6) {
        const label = String((nowHour - hours + 1 + i + 24) % 24).padStart(2, '0') + ':00';
        const span = document.createElement('span');
        span.textContent = label;
        hoursContainer.appendChild(span);
    }
}

// ═══════ RENDER SUMMARY ═══════
function renderSummary() {
    const body = document.getElementById('summaryBody');
    if (!summaryData || !summaryData.summary) {
        body.innerHTML = '<div class="empty-state">AWAITING AI ANALYSIS<br><small>UPDATES EVERY HOUR</small></div>';
        return;
    }
    body.innerHTML = `
        <div class="summary-text">${escapeHtml(summaryData.summary)}</div>
        <div class="summary-meta">
            <span>${summaryData.aiProvider || 'Gemini'} AI</span>
            <span>${formatDateTime(summaryData.generatedAt)}</span>
        </div>
    `;
}

// ═══════ RENDER STATS ═══════
function renderStats() {
    const items = Object.values(newsData);
    const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    const sources = new Set();

    items.forEach(item => {
        counts[item.urgency || 1]++;
        if (item.source) sources.add(item.source);
    });

    document.getElementById('statTotal').textContent = items.length;
    document.getElementById('statRed').textContent = counts[5];
    document.getElementById('statOrange').textContent = counts[4];
    document.getElementById('statYellow').textContent = counts[3];
    document.getElementById('statBlue').textContent = counts[2] + counts[1];
    document.getElementById('statSources').textContent = sources.size;
    document.getElementById('alertCount').textContent = items.length;
}

// ═══════ RENDER THREAT LEVEL ═══════
function renderThreatLevel() {
    const items = Object.values(newsData);
    let maxUrgency = 0;
    const recentCutoff = Date.now() - (6 * 60 * 60 * 1000);

    items.forEach(item => {
        if (item.timestamp > recentCutoff && item.urgency > maxUrgency) {
            maxUrgency = item.urgency;
        }
    });

    const circle = document.getElementById('threatCircle');
    const num = document.getElementById('threatNum');
    const label = document.getElementById('threatLabel');

    const levels = {
        0: { class: 'level-gray', label: 'CLEAR', color: '#666' },
        1: { class: 'level-gray', label: 'MINIMAL', color: '#666' },
        2: { class: 'level-blue', label: 'LOW', color: '#4488ff' },
        3: { class: 'level-yellow', label: 'ELEVATED', color: '#ffd000' },
        4: { class: 'level-orange', label: 'HIGH', color: '#ff8800' },
        5: { class: 'level-red', label: 'CRITICAL', color: '#ff0040' }
    };

    const level = levels[maxUrgency] || levels[0];
    circle.className = `threat-circle ${level.class}`;
    num.textContent = maxUrgency;
    num.style.color = level.color;
    label.textContent = level.label;
    label.style.color = level.color;

    const bars = document.querySelectorAll('.threat-bar');
    bars.forEach((bar, i) => {
        if (i < maxUrgency) {
            bar.style.background = level.color;
            bar.style.boxShadow = `0 0 8px ${level.color}`;
        } else {
            bar.style.background = 'var(--bg-primary)';
            bar.style.boxShadow = 'none';
        }
    });
}

// ═══════ RENDER SOURCES ═══════
function renderSources() {
    const items = Object.values(newsData);
    const sourceCounts = {};
    items.forEach(item => {
        if (item.source) sourceCounts[item.source] = (sourceCounts[item.source] || 0) + 1;
    });

    const list = document.getElementById('sourcesList');
    list.innerHTML = SOURCES.map(src => {
        const count = sourceCounts[src.id] || sourceCounts[src.name] || 0;
        const isActive = count > 0;
        const typeLabels = { local: 'LOCAL', regional: 'AREA', national: 'NATL', news: 'NEWS' };
        return `
            <div class="source-item">
                <div class="source-dot ${isActive ? 'active' : 'inactive'}"></div>
                <span class="source-name">${src.name}</span>
                <span class="source-type ${src.type}">${typeLabels[src.type]}</span>
                <span class="source-count">${count > 0 ? count : ''}</span>
            </div>
        `;
    }).join('');
}

function renderMeta() {
    if (metaData && metaData.lastRun) {
        document.getElementById('lastScan').textContent = formatTime(metaData.lastRun);
    }
}

// ═══════ HISTORY ═══════
function toggleHistory() {
    const overlay = document.getElementById('historyOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible')) {
        fetchHistory();
    }
}

async function fetchHistory() {
    try {
        const res = await fetch(`${FIREBASE_URL}/news.json`);
        const data = await res.json();
        if (data) allNewsData = data;
        renderHistory();
    } catch (e) {
        document.getElementById('historyBody').innerHTML = '<div class="empty-state">ERROR LOADING HISTORY</div>';
    }
}

function renderHistory() {
    const body = document.getElementById('historyBody');
    const searchText = (document.getElementById('historySearch').value || '').toLowerCase();
    let items = Object.values(allNewsData);

    if (historyFilter !== 'all') {
        items = items.filter(i => i.urgency === historyFilter);
    }
    if (searchText) {
        items = items.filter(i =>
            (i.title || '').toLowerCase().includes(searchText) ||
            (i.snippet || '').toLowerCase().includes(searchText) ||
            (i.fullText || '').toLowerCase().includes(searchText) ||
            (i.source || '').toLowerCase().includes(searchText)
        );
    }

    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    // Stats
    const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    items.forEach(i => counts[i.urgency || 1]++);
    document.getElementById('historyStats').innerHTML = `
        <div class="history-stat"><strong>${items.length}</strong> TOTAL</div>
        <div class="history-stat"><strong style="color:var(--red)">${counts[5]}</strong> RED</div>
        <div class="history-stat"><strong style="color:var(--orange)">${counts[4]}</strong> ORANGE</div>
        <div class="history-stat"><strong style="color:var(--yellow)">${counts[3]}</strong> YELLOW</div>
        <div class="history-stat"><strong style="color:var(--blue)">${counts[2] + counts[1]}</strong> BLUE</div>
    `;

    // Group by date
    const groups = {};
    items.forEach(item => {
        const d = new Date(item.timestamp || 0);
        const key = d.toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        if (!groups[key]) groups[key] = [];
        groups[key].push(item);
    });

    if (Object.keys(groups).length === 0) {
        body.innerHTML = '<div class="empty-state">NO MATCHING RECORDS</div>';
        return;
    }

    const colors = { 5: 'var(--red)', 4: 'var(--orange)', 3: 'var(--yellow)', 2: 'var(--blue)', 1: '#666' };

    body.innerHTML = Object.entries(groups).map(([date, dateItems]) => `
        <div class="history-date-group">
            <div class="history-date-header">${date} (${dateItems.length})</div>
            ${dateItems.map(item => `
                <div class="history-item">
                    <span class="history-item-time">${formatTime(item.timestamp)}</span>
                    <div class="history-item-urgency" style="background:${colors[item.urgency] || '#666'}; box-shadow: 0 0 6px ${colors[item.urgency] || '#666'};"></div>
                    <div class="history-item-content">
                        <div class="history-item-title">${escapeHtml(item.title || 'N/A')}</div>
                        <div class="history-item-text">${escapeHtml((item.snippet || item.fullText || '').substring(0, 200))}</div>
                        <div class="history-item-source">${escapeHtml(item.source || 'N/A')}${item.matchedLocations ? ' | ' + escapeHtml(item.matchedLocations.join(', ')) : ''}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `).join('');
}

// ═══════ UTILITIES ═══════
function formatTime(ts) {
    if (!ts) return '--:--';
    const d = new Date(ts);
    return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
}

function formatDateTime(ts) {
    if (!ts) return '--';
    const d = new Date(ts);
    return d.toLocaleDateString('he-IL') + ' ' + formatTime(ts);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ═══════ KEYBOARD SHORTCUTS ═══════
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (mapIsFullscreen) toggleMapFullscreen();
        const history = document.getElementById('historyOverlay');
        if (history.classList.contains('visible')) toggleHistory();
    }
    if (e.key === 'f' || e.key === 'F') {
        if (document.activeElement.tagName !== 'INPUT') toggleMapFullscreen();
    }
    if (e.key === 'h' || e.key === 'H') {
        if (document.activeElement.tagName !== 'INPUT') toggleHistory();
    }
});

// ═══════ REFRESH CYCLE ═══════
function startRefreshCycle() {
    const bar = document.getElementById('refreshBar');
    const nextEl = document.getElementById('nextRefresh');
    let elapsed = 0;

    setInterval(() => {
        elapsed += 1000;
        const remaining = Math.max(0, Math.ceil((REFRESH_INTERVAL - elapsed) / 1000));
        nextEl.textContent = `${remaining}s`;
        bar.style.width = `${(elapsed / REFRESH_INTERVAL) * 100}%`;

        if (elapsed >= REFRESH_INTERVAL) {
            elapsed = 0;
            bar.style.width = '0%';
            fetchData();
        }
    }, 1000);
}

// ═══════ INIT ═══════
document.addEventListener('DOMContentLoaded', () => {
    updateClock();
    setInterval(updateClock, 1000);
    initMap();
    fetchData();
    startRefreshCycle();
});
</script>
</body>
</html>
