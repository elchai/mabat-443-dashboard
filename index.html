<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>מבט 443 | פלטפורמת מודיעין גזרתית</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' rx='12' fill='%23040810'/%3E%3Cpath d='M50 15 Q65 15 73 27 Q78 35 77 47 Q75 57 68 63 L50 75 L32 63 Q25 57 23 47 Q22 35 27 27 Q35 15 50 15Z' fill='none' stroke='%2300d4ff' stroke-width='2'/%3E%3Cpath d='M33 20 L27 7 L38 17' fill='%2300d4ff' opacity='.6'/%3E%3Cpath d='M67 20 L73 7 L62 17' fill='%2300d4ff' opacity='.6'/%3E%3Ccircle cx='40' cy='37' r='9' fill='none' stroke='%2300d4ff' stroke-width='1.5'/%3E%3Ccircle cx='60' cy='37' r='9' fill='none' stroke='%2300d4ff' stroke-width='1.5'/%3E%3Ccircle cx='40' cy='37' r='4' fill='%23ffd000'/%3E%3Ccircle cx='60' cy='37' r='4' fill='%23ffd000'/%3E%3Ccircle cx='40' cy='37' r='1.5' fill='%23040810'/%3E%3Ccircle cx='60' cy='37' r='1.5' fill='%23040810'/%3E%3Cpath d='M47 43 L50 49 L53 43' fill='%23ff8800' opacity='.7'/%3E%3Cline x1='50' y1='65' x2='50' y2='93' stroke='%2300d4ff' stroke-width='2.5' opacity='.6'/%3E%3Cpath d='M44 67 L50 65 L56 67 L50 69Z' fill='%2300d4ff' opacity='.5'/%3E%3Cline x1='43' y1='68' x2='57' y2='68' stroke='%2300d4ff' stroke-width='1.5' opacity='.5'/%3E%3Cpath d='M48 91 L50 97 L52 91' fill='%2300d4ff' opacity='.5'/%3E%3C/svg%3E">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
/* ═══════════════════════════════════════
   MABAT 443 - CYBER DEFENSE DASHBOARD
   Futuristic Military Intelligence UI v2
   ═══════════════════════════════════════ */

@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap');

:root {
    --bg-primary: #040810;
    --bg-secondary: #0a1020;
    --bg-panel: rgba(8, 16, 35, 0.85);
    --bg-card: rgba(12, 22, 45, 0.9);
    --border-primary: #0f3460;
    --border-glow: #00d4ff;
    --cyan: #00d4ff;
    --cyan-dim: #00d4ff44;
    --green: #00ff88;
    --green-dim: #00ff8844;
    --red: #ff0040;
    --red-dim: #ff004044;
    --orange: #ff8800;
    --orange-dim: #ff880044;
    --yellow: #ffd000;
    --yellow-dim: #ffd00044;
    --blue: #4488ff;
    --purple: #a855f7;
    --purple-dim: #a855f744;
    --text-primary: #e0e8f0;
    --text-secondary: #9ab0c8;
    --text-dim: #6880a0;
    --font-display: 'Orbitron', monospace;
    --font-body: 'Rajdhani', sans-serif;
    --font-mono: 'Share Tech Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: var(--font-body);
    overflow: hidden;
    height: 100vh;
    width: 100vw;
}

/* ═══════ ANIMATED BACKGROUND ═══════ */
.bg-grid {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
        linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: 0;
    animation: gridPulse 4s ease-in-out infinite;
    pointer-events: none;
}

@keyframes gridPulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.scan-line {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    z-index: 1000;
    animation: scanDown 4s linear infinite;
    opacity: 0.4;
    box-shadow: 0 0 20px var(--cyan), 0 0 60px var(--cyan-dim);
    pointer-events: none;
}

@keyframes scanDown {
    0% { top: -3px; }
    100% { top: 100vh; }
}

/* ═══════ CORNER DECORATIONS ═══════ */
.corner-decor {
    position: fixed;
    width: 60px;
    height: 60px;
    z-index: 5;
    pointer-events: none;
}
.corner-decor::before, .corner-decor::after {
    content: '';
    position: absolute;
    background: var(--cyan);
    box-shadow: 0 0 10px var(--cyan);
}
.corner-tl { top: 10px; left: 10px; }
.corner-tl::before { width: 30px; height: 2px; top: 0; left: 0; }
.corner-tl::after { width: 2px; height: 30px; top: 0; left: 0; }
.corner-tr { top: 10px; right: 10px; }
.corner-tr::before { width: 30px; height: 2px; top: 0; right: 0; }
.corner-tr::after { width: 2px; height: 30px; top: 0; right: 0; }
.corner-bl { bottom: 10px; left: 10px; }
.corner-bl::before { width: 30px; height: 2px; bottom: 0; left: 0; }
.corner-bl::after { width: 2px; height: 30px; bottom: 0; left: 0; }
.corner-br { bottom: 10px; right: 10px; }
.corner-br::before { width: 30px; height: 2px; bottom: 0; right: 0; }
.corner-br::after { width: 2px; height: 30px; bottom: 0; right: 0; }

/* ═══════ MAIN LAYOUT ═══════ */
.dashboard {
    display: grid;
    grid-template-rows: 70px 1fr 280px;
    grid-template-columns: 280px 1fr 320px;
    height: 100vh;
    gap: 2px;
    padding: 8px;
    position: relative;
    z-index: 2;
}

/* ═══════ HEADER ═══════ */
.header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.08), transparent);
    border-bottom: 1px solid var(--border-primary);
    position: relative;
}

.header::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    box-shadow: 0 0 15px var(--cyan-dim);
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-hex {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: hexPulse 3s ease-in-out infinite;
    position: relative;
    filter: drop-shadow(0 0 8px var(--cyan-dim));
}

@keyframes hexPulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.4) drop-shadow(0 0 10px var(--cyan)); }
}

.system-title {
    font-family: var(--font-display);
    font-weight: 900;
    font-size: 22px;
    letter-spacing: 4px;
    background: linear-gradient(90deg, var(--cyan), #fff, var(--cyan));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
}

@keyframes shimmer {
    0% { background-position: 200% center; }
    100% { background-position: -200% center; }
}

.system-subtitle {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    letter-spacing: 2px;
}

.header-center {
    display: flex;
    align-items: center;
    gap: 15px;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 12px;
}

.header-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--cyan);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 1px;
}

.header-btn:hover {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--cyan);
    box-shadow: 0 0 15px var(--cyan-dim);
}

.header-btn .btn-icon {
    font-size: 14px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 10px var(--green);
    animation: dotPulse 2s ease-in-out infinite;
}

.status-dot.offline {
    background: var(--red);
    box-shadow: 0 0 10px var(--red);
}

@keyframes dotPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
    font-family: var(--font-mono);
}

.clock {
    font-size: 20px;
    letter-spacing: 2px;
    color: var(--cyan);
    text-shadow: 0 0 10px var(--cyan-dim);
}

.date-display {
    font-size: 11px;
    color: var(--text-secondary);
}

/* ═══════ PANELS ═══════ */
.panel {
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border-glow), transparent);
    opacity: 0.5;
    z-index: 1;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 212, 255, 0.03);
}

.panel-title {
    font-family: var(--font-display);
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--cyan);
}

.panel-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: dotPulse 2s ease-in-out infinite;
}

.panel-body {
    padding: 12px;
    overflow-y: auto;
    height: calc(100% - 42px);
}

.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.panel-body::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 2px; }
.panel-body::-webkit-scrollbar-thumb:hover { background: var(--cyan-dim); }

/* ═══════ LEFT PANEL ═══════ */
.left-panel {
    grid-row: 2 / 4;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* Threat Level */
.threat-container { flex: 0 0 200px; }

.threat-gauge {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    gap: 10px;
}

.threat-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid var(--border-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    position: relative;
    transition: all 0.5s ease;
}

.threat-circle::before {
    content: '';
    position: absolute;
    inset: -8px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-top-color: var(--cyan);
    animation: rotate 3s linear infinite;
}

.threat-circle::after {
    content: '';
    position: absolute;
    inset: -14px;
    border-radius: 50%;
    border: 1px solid transparent;
    border-bottom-color: var(--cyan-dim);
    animation: rotate 5s linear infinite reverse;
}

@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.threat-circle.level-green { border-color: var(--green); box-shadow: 0 0 30px rgba(0, 255, 136, 0.2); }
.threat-circle.level-gray { border-color: #666; }
.threat-circle.level-blue { border-color: var(--blue); box-shadow: 0 0 30px rgba(68, 136, 255, 0.2); }
.threat-circle.level-yellow { border-color: var(--yellow); box-shadow: 0 0 30px rgba(255, 208, 0, 0.2); }
.threat-circle.level-orange { border-color: var(--orange); box-shadow: 0 0 30px rgba(255, 136, 0, 0.3); }
.threat-circle.level-red { border-color: var(--red); box-shadow: 0 0 40px rgba(255, 0, 64, 0.4); animation: threatPulse 1.5s ease-in-out infinite; }

@keyframes threatPulse {
    0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 64, 0.3); }
    50% { box-shadow: 0 0 60px rgba(255, 0, 64, 0.6); }
}

.threat-level-num {
    font-family: var(--font-display);
    font-size: 36px;
    font-weight: 900;
    line-height: 1;
}

.threat-level-label {
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 2px;
}

.threat-bars {
    display: flex;
    gap: 4px;
    width: 100%;
    height: 6px;
}

.threat-bar {
    flex: 1;
    border-radius: 2px;
    background: var(--bg-primary);
    transition: all 0.3s ease;
}

/* Stats */
.stats-container { flex: 1; }

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(15, 52, 96, 0.4);
}

.stat-label {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
}

.stat-value {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 700;
    color: var(--cyan);
}

.stat-value.red { color: var(--red); }
.stat-value.orange { color: var(--orange); }
.stat-value.yellow { color: var(--yellow); }
.stat-value.green { color: var(--green); }

/* Sources */
.sources-container { flex: 0 0 auto; }

.source-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    font-family: var(--font-mono);
    font-size: 11px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
}

.source-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
}

.source-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
.source-dot.inactive { background: #444; }

.source-name {
    flex: 1;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.source-type {
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 2px;
    border: 1px solid var(--border-primary);
}

.source-type.local { color: var(--green); border-color: var(--green-dim); }
.source-type.regional { color: var(--orange); border-color: var(--orange-dim); }
.source-type.national { color: var(--cyan); border-color: var(--cyan-dim); }
.source-type.news { color: var(--yellow); border-color: var(--yellow-dim); }

.source-count {
    color: var(--cyan);
    font-size: 10px;
}

/* ═══════ CENTER - MAP ═══════ */
.map-panel { position: relative; transition: all 0.4s ease; }

.map-panel.fullscreen {
    position: fixed !important;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9000;
    border-radius: 0;
    grid-row: auto;
    grid-column: auto;
}

#map {
    width: 100%;
    height: 100%;
    background: var(--bg-primary);
}

.leaflet-container {
    background: var(--bg-primary) !important;
    font-family: var(--font-mono) !important;
}

.map-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 1000;
    border: 1px solid var(--border-primary);
    box-shadow: inset 0 0 60px rgba(0, 0, 0, 0.5);
}

.map-overlay::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: repeating-linear-gradient(90deg, transparent, transparent 4px, var(--cyan-dim) 4px, var(--cyan-dim) 5px);
}

.map-coords {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    z-index: 1001;
    pointer-events: none;
}

.map-label {
    position: absolute;
    top: 10px;
    right: 10px;
    font-family: var(--font-display);
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--cyan);
    z-index: 1001;
    pointer-events: none;
    text-shadow: 0 0 10px var(--cyan-dim);
}

.map-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1001;
    background: var(--bg-panel);
    border: 1px solid var(--border-primary);
    color: var(--cyan);
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 12px;
    transition: all 0.3s ease;
}

.map-btn:hover {
    background: rgba(0, 212, 255, 0.15);
    border-color: var(--cyan);
    box-shadow: 0 0 10px var(--cyan-dim);
}

/* ═══════ RIGHT PANEL - AI SUMMARY ═══════ */
.right-panel {
    grid-row: 3 / 4;
    grid-column: 3 / 4;
    display: flex;
    flex-direction: column;
}

.summary-text {
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-primary);
    direction: rtl;
    white-space: pre-wrap;
}

.summary-meta {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border-primary);
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    justify-content: space-between;
}

.ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 8px;
    border: 1px solid var(--cyan-dim);
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--cyan);
    letter-spacing: 1px;
}

.ai-badge::before {
    content: '\25C6';
    font-size: 6px;
    animation: dotPulse 1.5s ease-in-out infinite;
}

/* Config Panel */
.config-panel {
    grid-row: 2 / 3;
    grid-column: 3 / 4;
}

.config-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    font-family: var(--font-mono);
    font-size: 11px;
}

.config-key { color: var(--text-secondary); }
.config-val { color: var(--cyan); }

/* ═══════ BOTTOM - ALERT FEED ═══════ */
.alert-feed { grid-column: 2 / 3; display: flex; flex-direction: column; }

.alert-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.filter-chip {
    padding: 3px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    font-family: var(--font-mono);
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    color: var(--text-dim);
    letter-spacing: 1px;
}

.filter-chip:hover { border-color: var(--cyan-dim); color: var(--text-secondary); }
.filter-chip.active { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 212, 255, 0.08); }
.filter-chip.active.red { border-color: var(--red); color: var(--red); background: var(--red-dim); }
.filter-chip.active.orange { border-color: var(--orange); color: var(--orange); background: var(--orange-dim); }
.filter-chip.active.yellow { border-color: var(--yellow); color: var(--yellow); background: var(--yellow-dim); }
.filter-chip.active.blue { border-color: var(--blue); color: var(--blue); background: rgba(68,136,255,0.12); }
.filter-chip.active.purple { border-color: var(--purple); color: var(--purple); background: var(--purple-dim); }

/* Anarchist toggle */
.toggle-container {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--purple);
    padding: 0 8px;
}

.toggle-switch {
    position: relative;
    width: 32px;
    height: 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-switch.active {
    background: var(--purple-dim);
    border-color: var(--purple);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-dim);
    transition: all 0.3s ease;
}

.toggle-switch.active::after {
    left: 18px;
    background: var(--purple);
    box-shadow: 0 0 6px var(--purple);
}

.search-input {
    flex: 1;
    max-width: 220px;
    padding: 4px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 11px;
    outline: none;
    direction: rtl;
    transition: border-color 0.3s ease;
}

.search-input::placeholder { color: var(--text-dim); }
.search-input:focus { border-color: var(--cyan); box-shadow: 0 0 8px var(--cyan-dim); }

.alert-feed .panel-body {
    padding: 0;
    flex: 1;
    overflow-y: auto;
}

.alert-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 15px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.3);
    transition: background 0.3s ease;
    direction: rtl;
    cursor: pointer;
}

.alert-item:hover { background: rgba(0, 212, 255, 0.03); }

.alert-item.expanded {
    background: rgba(0, 212, 255, 0.05);
    flex-direction: column;
    gap: 8px;
}

.alert-item.new-alert { animation: alertFlash 2s ease; }

@keyframes alertFlash {
    0% { background: rgba(0, 212, 255, 0.2); }
    100% { background: transparent; }
}

.alert-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    width: 100%;
}

.alert-time {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    white-space: nowrap;
    min-width: 45px;
    padding-top: 2px;
}

.alert-urgency {
    width: 8px; min-width: 8px; height: 8px;
    border-radius: 50%;
    margin-top: 5px;
    flex-shrink: 0;
}

.alert-urgency.urgency-5 { background: var(--red); box-shadow: 0 0 10px var(--red); animation: dotPulse 1s ease-in-out infinite; }
.alert-urgency.urgency-4 { background: var(--orange); box-shadow: 0 0 8px var(--orange); }
.alert-urgency.urgency-3 { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
.alert-urgency.urgency-2 { background: var(--blue); box-shadow: 0 0 6px var(--blue); }
.alert-urgency.urgency-1 { background: #666; }
.alert-urgency.urgency-anarchist { background: var(--purple); box-shadow: 0 0 8px var(--purple); }

.alert-content { flex: 1; min-width: 0; }

.alert-title {
    font-family: var(--font-body);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.alert-snippet {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.alert-full-text {
    font-family: var(--font-body);
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 8px 12px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.2);
    white-space: pre-wrap;
    direction: rtl;
}

.alert-meta-row {
    display: flex;
    gap: 10px;
    align-items: center;
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
}

.alert-source {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    white-space: nowrap;
    padding: 2px 6px;
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    margin-top: 2px;
}

/* ═══════ TIMELINE GRAPH ═══════ */
.timeline-graph {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-primary);
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.timeline-label {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    margin-bottom: 4px;
    letter-spacing: 1px;
}

.timeline-bars {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 35px;
}

.timeline-bar {
    flex: 1;
    min-width: 2px;
    background: var(--cyan-dim);
    border-radius: 1px 1px 0 0;
    transition: all 0.3s ease;
    position: relative;
}

.timeline-bar:hover {
    opacity: 0.8;
}

.timeline-bar.has-red { background: var(--red); box-shadow: 0 0 4px var(--red-dim); }
.timeline-bar.has-orange { background: var(--orange); }
.timeline-bar.has-yellow { background: var(--yellow); }
.timeline-bar.has-blue { background: var(--blue); }

.timeline-hours {
    display: flex;
    justify-content: space-between;
    font-family: var(--font-mono);
    font-size: 8px;
    color: var(--text-dim);
    margin-top: 2px;
}

/* ═══════ HISTORY OVERLAY ═══════ */
.history-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(4, 8, 16, 0.95);
    z-index: 8000;
    display: none;
    flex-direction: column;
    animation: fadeIn 0.3s ease;
}

.history-overlay.visible {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 25px;
    border-bottom: 1px solid var(--border-primary);
    background: linear-gradient(180deg, rgba(0, 212, 255, 0.06), transparent);
}

.history-title {
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 4px;
    color: var(--cyan);
}

.history-close {
    background: transparent;
    border: 1px solid var(--border-primary);
    color: var(--text-secondary);
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 12px;
    transition: all 0.3s ease;
}

.history-close:hover {
    border-color: var(--red);
    color: var(--red);
}

.history-filters {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 25px;
    border-bottom: 1px solid var(--border-primary);
    flex-wrap: wrap;
}

.history-search {
    flex: 1;
    max-width: 300px;
    padding: 6px 14px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 12px;
    outline: none;
    direction: rtl;
}

.history-search:focus { border-color: var(--cyan); }

.history-date-filter {
    padding: 5px 10px;
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text-primary);
    font-family: var(--font-mono);
    font-size: 11px;
}

.history-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px 25px;
}

.history-body::-webkit-scrollbar { width: 6px; }
.history-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.history-body::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; }

.history-date-group {
    margin-bottom: 20px;
}

.history-date-header {
    font-family: var(--font-display);
    font-size: 12px;
    letter-spacing: 2px;
    color: var(--cyan);
    padding: 8px 0;
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: 8px;
    position: sticky;
    top: 0;
    background: rgba(4, 8, 16, 0.95);
    z-index: 1;
}

.history-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(15, 52, 96, 0.2);
    border-radius: 4px;
    transition: background 0.2s ease;
    direction: rtl;
}

.history-item:hover {
    background: rgba(0, 212, 255, 0.03);
}

.history-item-time {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-dim);
    min-width: 50px;
    padding-top: 2px;
}

.history-item-urgency {
    width: 10px; height: 10px;
    border-radius: 50%;
    margin-top: 4px;
    flex-shrink: 0;
}

.history-item-content {
    flex: 1;
}

.history-item-title {
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
}

.history-item-text {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.5;
}

.history-item-source {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
}

.history-stat-bar {
    display: flex;
    gap: 15px;
    padding: 10px 25px;
    border-bottom: 1px solid var(--border-primary);
    font-family: var(--font-mono);
    font-size: 12px;
}

.history-stat {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
}

.history-stat strong {
    color: var(--cyan);
    font-family: var(--font-display);
}

/* ═══════ RED ALERT FLASH ═══════ */
.red-alert-flash {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
}

.red-alert-flash.active {
    animation: redFlash 3s ease-out;
}

@keyframes redFlash {
    0% { opacity: 1; background: rgba(255, 0, 64, 0.3); }
    10% { opacity: 0.8; background: rgba(255, 0, 64, 0.15); }
    20% { opacity: 1; background: rgba(255, 0, 64, 0.25); }
    30% { opacity: 0.5; background: rgba(255, 0, 64, 0.1); }
    100% { opacity: 0; }
}

/* ═══════ LOADING / EMPTY ═══════ */
.loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 15px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
}

.loading-spinner {
    width: 40px; height: 40px;
    border: 2px solid var(--border-primary);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
    text-align: center;
    padding: 30px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
}

/* ═══════ REFRESH BAR ═══════ */
.refresh-bar {
    position: fixed;
    bottom: 0; left: 0;
    height: 2px;
    background: var(--cyan);
    z-index: 1001;
    transition: width 1s linear;
    box-shadow: 0 0 10px var(--cyan);
}

/* ═══════ URGENCY TAG ═══════ */
.urgency-tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1px;
    font-weight: 600;
}

.urgency-tag.red { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
.urgency-tag.orange { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange); }
.urgency-tag.yellow { background: var(--yellow-dim); color: var(--yellow); border: 1px solid var(--yellow); }
.urgency-tag.blue { background: rgba(68,136,255,0.15); color: var(--blue); border: 1px solid var(--blue); }

/* ═══════ RESPONSIVE ═══════ */
@media (max-width: 1200px) {
    .dashboard { grid-template-columns: 220px 1fr 260px; }
}

@media (max-width: 900px) {
    body { overflow-y: auto; overflow-x: hidden; }

    .dashboard {
        display: flex;
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding: 4px;
        gap: 4px;
    }

    .header {
        flex-wrap: wrap;
        padding: 8px 12px;
        gap: 8px;
        min-height: 60px;
        height: auto;
        justify-content: center;
    }

    .logo-section {
        width: 100%;
        justify-content: center;
    }

    .system-title { font-size: 16px; letter-spacing: 2px; }
    .system-subtitle { font-size: 9px; display: none; }
    .logo-hex { width: 35px; height: 35px; }
    .header-center { gap: 6px; flex-wrap: wrap; justify-content: center; width: 100%; }
    .header-center .status-badge { padding: 3px 8px; font-size: 10px; }
    .header-right { display: none; }

    .map-panel {
        height: 45vh;
        min-height: 280px;
        order: 1;
    }

    .alert-feed {
        min-height: 300px;
        max-height: 50vh;
        order: 2;
    }

    .alert-toolbar { flex-wrap: wrap; gap: 4px; padding: 4px 8px; }
    .filter-chip { padding: 4px 8px; font-size: 9px; }
    .search-input { max-width: 100%; min-width: 120px; }

    .timeline-graph { padding: 4px 8px; }
    .timeline-bars { height: 25px; }

    .alert-item { padding: 8px 10px; gap: 8px; }
    .alert-title { font-size: 12px; white-space: normal; overflow: visible; text-overflow: unset; }
    .alert-snippet { font-size: 10px; white-space: normal; overflow: visible; text-overflow: unset; line-height: 1.5; }
    .alert-source { font-size: 8px; padding: 1px 4px; }

    .left-panel {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        order: 3;
    }

    .threat-container {
        flex: 1 1 160px;
        max-width: 50%;
    }

    .threat-gauge { padding: 10px; }
    .threat-circle { width: 90px; height: 90px; }
    .threat-level-num { font-size: 28px; }

    .stats-container {
        flex: 1 1 160px;
        max-width: 50%;
    }

    .sources-container {
        flex: 1 1 100%;
    }

    .right-panel {
        order: 4;
        min-height: 200px;
    }

    .config-panel {
        order: 5;
    }

    .panel-title { font-size: 9px; letter-spacing: 2px; }
    .stat-label { font-size: 10px; }
    .stat-value { font-size: 14px; }

    .map-btn { font-size: 10px; padding: 4px 8px; }

    .history-header { padding: 10px 15px; }
    .history-title { font-size: 14px; }
    .history-filters { padding: 8px 15px; gap: 6px; }
    .history-body { padding: 10px 15px; }
    .history-item { padding: 8px; }
    .history-stat-bar { padding: 8px 15px; gap: 8px; font-size: 10px; flex-wrap: wrap; }

    .corner-decor { display: none; }
}

@media (max-width: 480px) {
    .header-center .status-badge:nth-child(2) { display: none; }
    .header-btn { padding: 4px 8px; font-size: 10px; }
    .header-btn .btn-icon { font-size: 12px; }
    .logo-section { gap: 8px; }
    .map-panel { height: 35vh; min-height: 220px; }
    .threat-container, .stats-container { max-width: 100%; flex: 1 1 100%; }
    .alert-toolbar .toggle-container span:last-child { display: none; }
}

/* Dark tooltip */
.dark-tooltip {
    background: rgba(8, 16, 35, 0.95) !important;
    color: #e0e8f0 !important;
    border: 1px solid #0f3460 !important;
    border-radius: 4px !important;
    font-family: 'Rajdhani', 'Share Tech Mono', monospace !important;
    font-size: 11px !important;
    padding: 8px 12px !important;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.25) !important;
    max-width: 280px !important;
}
.dark-tooltip::before { border-top-color: #0f3460 !important; }

/* ═══════ MAP LEGEND ═══════ */
.map-legend {
    position: absolute;
    bottom: 10px;
    right: 10px;
    z-index: 1001;
    background: rgba(4, 8, 16, 0.9);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    padding: 8px 12px;
    font-family: var(--font-mono);
    font-size: 10px;
    direction: rtl;
    pointer-events: auto;
    max-width: 140px;
}
.legend-title {
    font-family: var(--font-display);
    font-size: 9px;
    color: var(--cyan);
    letter-spacing: 2px;
    margin-bottom: 6px;
    text-align: center;
}
.legend-subtitle {
    font-size: 9px;
    color: var(--text-secondary);
    margin-bottom: 3px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 2px 0;
    color: var(--text-primary);
}
.legend-circle {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.legend-ring {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid;
    background: transparent;
    flex-shrink: 0;
}
.legend-divider {
    height: 1px;
    background: var(--border-primary);
    margin: 5px 0;
}

.threat-ring-pulse {
    animation: ringPulse 2s ease-in-out infinite;
}
@keyframes ringPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 0.3; }
}

.leaflet-popup-content-wrapper {
    background: rgba(8, 16, 35, 0.95) !important;
    color: #e0e8f0 !important;
    border: 1px solid #0f3460 !important;
    border-radius: 4px !important;
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.2) !important;
}
.leaflet-popup-tip { background: rgba(8, 16, 35, 0.95) !important; }

/* ═══════ LOGIN SCREEN ═══════ */
.login-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 99999;
    background: var(--bg-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.login-overlay .bg-grid-login {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
        linear-gradient(rgba(0, 212, 255, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridPulse 4s ease-in-out infinite;
    pointer-events: none;
}

.login-overlay .scan-line-login {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    animation: scanDown 5s linear infinite;
    opacity: 0.3;
    pointer-events: none;
}

.login-box {
    position: relative;
    z-index: 10;
    text-align: center;
    padding: 50px 60px;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    background: rgba(8, 16, 35, 0.9);
    box-shadow: 0 0 60px rgba(0, 212, 255, 0.08), inset 0 0 40px rgba(0, 0, 0, 0.3);
    min-width: 380px;
    max-width: 450px;
}

.login-box::before {
    content: '';
    position: absolute;
    top: -1px; left: -1px; right: -1px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
}

.login-box::after {
    content: '';
    position: absolute;
    bottom: -1px; left: -1px; right: -1px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--cyan-dim), transparent);
}

.login-hex {
    width: 100px;
    height: 100px;
    margin: 0 auto 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: hexPulse 3s ease-in-out infinite;
    filter: drop-shadow(0 0 15px var(--cyan-dim));
}

.login-title {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 900;
    letter-spacing: 6px;
    background: linear-gradient(90deg, var(--cyan), #fff, var(--cyan));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
    margin-bottom: 8px;
}

.login-subtitle {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text-secondary);
    letter-spacing: 3px;
    margin-bottom: 35px;
}

.login-field {
    position: relative;
    margin-bottom: 20px;
}

.login-field label {
    display: block;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-align: right;
    margin-bottom: 6px;
}

.login-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    color: var(--cyan);
    font-family: var(--font-mono);
    font-size: 18px;
    letter-spacing: 8px;
    text-align: center;
    outline: none;
    transition: all 0.3s ease;
    direction: ltr;
}

.login-input:focus {
    border-color: var(--cyan);
    box-shadow: 0 0 20px var(--cyan-dim);
}

.login-input.error {
    border-color: var(--red);
    box-shadow: 0 0 20px var(--red-dim);
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
}

.login-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(68, 136, 255, 0.15));
    border: 1px solid var(--cyan-dim);
    border-radius: 4px;
    color: var(--cyan);
    font-family: var(--font-display);
    font-size: 14px;
    letter-spacing: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn:hover {
    background: linear-gradient(135deg, rgba(0, 212, 255, 0.25), rgba(68, 136, 255, 0.25));
    border-color: var(--cyan);
    box-shadow: 0 0 25px var(--cyan-dim);
}

.login-error {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--red);
    height: 16px;
    margin-top: 10px;
    letter-spacing: 1px;
}

.login-classification {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-display);
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--red);
    z-index: 2;
    text-shadow: 0 0 10px var(--red-dim);
    pointer-events: none;
}

.login-footer {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-dim);
    z-index: 2;
    pointer-events: none;
    white-space: nowrap;
}

/* ═══════ CREDIT FOOTER ═══════ */
.credit-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    text-align: center;
    padding: 4px 10px;
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-dim);
    background: linear-gradient(0deg, rgba(4, 8, 16, 0.9), transparent);
    letter-spacing: 1px;
    pointer-events: auto;
}

.credit-footer a {
    color: var(--green);
    text-decoration: none;
    transition: color 0.3s ease;
}

.credit-footer a:hover {
    color: var(--cyan);
    text-shadow: 0 0 8px var(--cyan-dim);
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:#040810;display:flex;align-items:center;justify-content:center;flex-direction:column;">
    <div style="position:absolute;top:0;left:0;right:0;bottom:0;background-image:linear-gradient(rgba(0,212,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;"></div>
    <div style="position:absolute;top:15px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;color:#ff0040;pointer-events:none;white-space:nowrap;">CLASSIFIED // RESTRICTED ACCESS</div>
    <div style="position:relative;z-index:10;text-align:center;padding:50px 60px;border:1px solid #0f3460;border-radius:8px;background:rgba(8,16,35,0.9);box-shadow:0 0 60px rgba(0,212,255,0.08);min-width:340px;">
        <div style="width:80px;height:80px;margin:0 auto 25px;display:flex;align-items:center;justify-content:center;">
            <svg viewBox="0 0 100 120" width="80" height="96" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 5 L90 25 L90 75 L50 115 L10 75 L10 25 Z" fill="none" stroke="#00d4ff" stroke-width="1.5" opacity="0.4"/>
                <path d="M50 25 Q62 25 70 35 Q75 42 74 52 Q72 62 65 68 L50 80 L35 68 Q28 62 26 52 Q25 42 30 35 Q38 25 50 25Z" fill="rgba(0,212,255,0.08)" stroke="#00d4ff" stroke-width="1.2"/>
                <path d="M35 28 L30 15 L40 25" fill="#00d4ff" opacity="0.5"/><path d="M65 28 L70 15 L60 25" fill="#00d4ff" opacity="0.5"/>
                <circle cx="39" cy="42" r="9" fill="none" stroke="#00d4ff" stroke-width="1.2"/>
                <circle cx="61" cy="42" r="9" fill="none" stroke="#00d4ff" stroke-width="1.2"/>
                <circle cx="39" cy="42" r="4" fill="#ffd000"/><circle cx="61" cy="42" r="4" fill="#ffd000"/>
                <circle cx="39" cy="42" r="1.5" fill="#040810"/><circle cx="61" cy="42" r="1.5" fill="#040810"/>
                <path d="M47 48 L50 54 L53 48" fill="#ff8800" opacity="0.6"/>
                <line x1="50" y1="70" x2="50" y2="105" stroke="#00d4ff" stroke-width="1.8" opacity="0.7"/>
                <path d="M45 72 L50 70 L55 72 L50 74 Z" fill="#00d4ff" opacity="0.5"/>
            </svg>
        </div>
        <div style="font-family:'Orbitron',monospace;font-size:28px;font-weight:900;letter-spacing:6px;color:#00d4ff;margin-bottom:8px;">MABAT 443</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:12px;color:#7088a0;letter-spacing:3px;margin-bottom:35px;">פלטפורמת מודיעין גזרתית</div>
        <div style="margin-bottom:20px;text-align:right;">
            <label style="display:block;font-family:'Share Tech Mono',monospace;font-size:10px;color:#3a4a5c;letter-spacing:2px;margin-bottom:6px;">קוד גישה</label>
            <input id="loginInput" type="text" autocomplete="off" data-lpignore="true" data-1p-ignore maxlength="10" placeholder="••••"
                style="width:100%;padding:12px 16px;background:rgba(0,0,0,0.4);border:1px solid #0f3460;border-radius:4px;color:#00d4ff;font-family:'Share Tech Mono',monospace;font-size:18px;letter-spacing:8px;text-align:center;outline:none;box-sizing:border-box;-webkit-text-security:disc;-moz-text-security:disc;text-security:disc;"
                onfocus="this.style.borderColor='#00d4ff';this.style.boxShadow='0 0 20px rgba(0,212,255,0.15)'"
                onblur="this.style.borderColor='#0f3460';this.style.boxShadow='none'">
        </div>
        <button onclick="doLogin()" style="width:100%;padding:12px;background:linear-gradient(135deg,rgba(0,212,255,0.15),rgba(68,136,255,0.15));border:1px solid rgba(0,212,255,0.3);border-radius:4px;color:#00d4ff;font-family:'Orbitron',monospace;font-size:14px;letter-spacing:4px;cursor:pointer;">כניסה למערכת</button>
        <div id="loginError" style="font-family:'Share Tech Mono',monospace;font-size:11px;color:#ff0040;height:16px;margin-top:10px;letter-spacing:1px;"></div>
    </div>
    <div style="position:absolute;bottom:15px;font-family:'Share Tech Mono',monospace;font-size:9px;color:#3a4a5c;pointer-events:none;">SECTOR DEFENSE INTELLIGENCE PLATFORM v2.0</div>
</div>
<script>
function doLogin() {
    var input = document.getElementById('loginInput');
    var err = document.getElementById('loginError');
    if (input.value === '1875') {
        var ov = document.getElementById('loginOverlay');
        ov.style.transition = 'opacity 0.8s ease';
        ov.style.opacity = '0';
        setTimeout(function() { ov.style.display = 'none'; }, 800);
    } else {
        err.textContent = 'קוד גישה שגוי // ACCESS DENIED';
        input.style.borderColor = '#ff0040';
        input.style.boxShadow = '0 0 20px rgba(255,0,64,0.15)';
        input.value = '';
        setTimeout(function() { err.textContent = ''; input.style.borderColor = '#0f3460'; input.style.boxShadow = 'none'; }, 2000);
    }
}
document.getElementById('loginInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') doLogin();
});
</script>

<!-- Background Effects -->
<div class="bg-grid"></div>
<div class="scan-line"></div>
<div class="corner-decor corner-tl"></div>
<div class="corner-decor corner-tr"></div>
<div class="corner-decor corner-bl"></div>
<div class="corner-decor corner-br"></div>

<!-- Red Alert Flash -->
<div class="red-alert-flash" id="redAlertFlash"></div>

<!-- Dashboard Grid -->
<div class="dashboard" id="mainDashboard">

    <!-- HEADER -->
    <header class="header">
        <div class="logo-section">
            <div class="logo-hex"><svg viewBox="0 0 100 120" width="40" height="48" xmlns="http://www.w3.org/2000/svg">
<path d="M50 5 L90 25 L90 75 L50 115 L10 75 L10 25 Z" fill="none" stroke="#00d4ff" stroke-width="2" opacity="0.4"/>
<path d="M50 10 L85 28 L85 72 L50 108 L15 72 L15 28 Z" fill="rgba(0,212,255,0.05)" stroke="#0f3460" stroke-width="1"/>
<path d="M12 52 Q5 42 8 30 Q12 38 22 42 L30 50 Z" fill="#00d4ff" opacity="0.3" stroke="#00d4ff" stroke-width="0.7"/>
<path d="M88 52 Q95 42 92 30 Q88 38 78 42 L70 50 Z" fill="#00d4ff" opacity="0.3" stroke="#00d4ff" stroke-width="0.7"/>
<path d="M50 25 Q62 25 70 35 Q75 42 74 52 Q72 62 65 68 L50 80 L35 68 Q28 62 26 52 Q25 42 30 35 Q38 25 50 25Z" fill="rgba(0,212,255,0.1)" stroke="#00d4ff" stroke-width="1.5"/>
<path d="M35 28 L30 15 L40 25" fill="#00d4ff" opacity="0.6" stroke="#00d4ff" stroke-width="1"/>
<path d="M65 28 L70 15 L60 25" fill="#00d4ff" opacity="0.6" stroke="#00d4ff" stroke-width="1"/>
<circle cx="39" cy="42" r="9" fill="none" stroke="#00d4ff" stroke-width="1.5"/>
<circle cx="61" cy="42" r="9" fill="none" stroke="#00d4ff" stroke-width="1.5"/>
<circle cx="39" cy="42" r="4" fill="#ffd000" opacity="0.9"><animate attributeName="opacity" values="0.9;0.4;0.9" dur="3s" repeatCount="indefinite"/></circle>
<circle cx="61" cy="42" r="4" fill="#ffd000" opacity="0.9"><animate attributeName="opacity" values="0.9;0.4;0.9" dur="3s" repeatCount="indefinite"/></circle>
<circle cx="39" cy="42" r="1.5" fill="#040810"/>
<circle cx="61" cy="42" r="1.5" fill="#040810"/>
<path d="M28 36 Q39 30 50 36 Q61 30 72 36" fill="none" stroke="#00d4ff" stroke-width="1.2" opacity="0.6"/>
<path d="M47 48 L50 54 L53 48" fill="#ff8800" opacity="0.7" stroke="#ff8800" stroke-width="0.7"/>
<line x1="50" y1="70" x2="50" y2="105" stroke="#00d4ff" stroke-width="2" opacity="0.6"/>
<path d="M45 72 L50 70 L55 72 L50 74 Z" fill="#00d4ff" opacity="0.5"/>
<line x1="44" y1="73" x2="56" y2="73" stroke="#00d4ff" stroke-width="1.5" opacity="0.5"/>
<path d="M48 103 L50 110 L52 103" fill="#00d4ff" opacity="0.4"/>
</svg></div>
            <div>
                <div class="system-title">MABAT 443</div>
                <div class="system-subtitle">פלטפורמת מודיעין גזרתית</div>
            </div>
        </div>

        <div class="header-center">
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ONLINE</span>
            </div>
            <div class="status-badge">
                <span>סריקה</span>
                <span id="lastScan" style="color: var(--cyan);">--:--</span>
            </div>
            <div class="status-badge" onclick="scrollToAlerts()" style="cursor:pointer;">
                <span>התראות</span>
                <span id="alertCount" style="color: var(--orange);">0</span>
            </div>
            <button class="header-btn" onclick="toggleHistory()">
                <span class="btn-icon">&#9776;</span>
                <span>היסטוריה</span>
            </button>
            <button class="header-btn" onclick="loadDemoData()" style="color:var(--yellow);border-color:var(--yellow-dim);">
                <span class="btn-icon">&#9881;</span>
                <span>הדגמה</span>
            </button>
        </div>

        <div class="header-right">
            <div>
                <div class="clock" id="clock">00:00:00</div>
                <div class="date-display" id="dateDisplay"></div>
            </div>
        </div>
    </header>

    <!-- LEFT PANEL -->
    <div class="left-panel">
        <div class="panel threat-container">
            <div class="panel-header">
                <span class="panel-title">רמת איום</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="threat-gauge">
                <div class="threat-circle level-gray" id="threatCircle">
                    <div class="threat-level-num" id="threatNum">0</div>
                    <div class="threat-level-label" id="threatLabel">CLEAR</div>
                </div>
                <div class="threat-bars" id="threatBars">
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                    <div class="threat-bar"></div>
                </div>
            </div>
        </div>

        <div class="panel stats-container">
            <div class="panel-header">
                <span class="panel-title">נתונים</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="panel-body">
                <div class="stat-row">
                    <span class="stat-label">סה"כ</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ודאי</span>
                    <span class="stat-value red" id="statRed">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">חזק</span>
                    <span class="stat-value orange" id="statOrange">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">בינוני</span>
                    <span class="stat-value yellow" id="statYellow">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">חלש</span>
                    <span class="stat-value" id="statBlue">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">מקורות</span>
                    <span class="stat-value green" id="statSources">0</span>
                </div>
            </div>
        </div>

        <div class="panel sources-container">
            <div class="panel-header">
                <span class="panel-title">מקורות</span>
                <div class="panel-indicator"></div>
            </div>
            <div class="panel-body" id="sourcesList">
                <div class="loading-state"><div class="loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- CENTER - MAP -->
    <div class="panel map-panel" id="mapPanel">
        <div id="map"></div>
        <div class="map-overlay"></div>
        <div class="map-coords">31.870N  35.120E</div>
        <div class="map-label">גזרה 443</div>
        <button class="map-btn" onclick="toggleMapFullscreen()" id="mapBtn" title="F = Fullscreen">&#x26F6; הרחב</button>
        <div class="map-legend" id="mapLegend">
            <div class="legend-title">מקרא</div>
            <div class="legend-item"><span class="legend-circle" style="background:#ff8800;"></span> כפר ערבי</div>
            <div class="legend-item"><span class="legend-circle" style="background:#4488ff;"></span> ישוב ישראלי</div>
            <div class="legend-item"><span class="legend-circle" style="background:#00d4ff;"></span> ציר / מחסום</div>
            <div class="legend-divider"></div>
            <div class="legend-subtitle">טבעת איום:</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#ff0040;"></span> ודאי</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#ff8800;"></span> חזק</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#ffd000;"></span> בינוני</div>
            <div class="legend-item"><span class="legend-ring" style="border-color:#4488ff;"></span> חלש</div>
        </div>
    </div>

    <!-- RIGHT PANEL - AI SUMMARY -->
    <div class="panel right-panel">
        <div class="panel-header">
            <span class="panel-title">סקירה כללית</span>
            <span class="ai-badge">GEMINI AI</span>
        </div>
        <div class="panel-body" id="summaryBody">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>ממתין לניתוח AI...</span>
            </div>
        </div>
    </div>

    <!-- BOTTOM - ALERT FEED -->
    <div class="panel alert-feed" id="alertFeedPanel">
        <div class="panel-header">
            <span class="panel-title">פיד חי</span>
            <div style="display:flex; gap:8px; align-items:center;">
                <span class="urgency-tag red">ודאי</span>
                <span class="urgency-tag orange">חזק</span>
                <span class="urgency-tag yellow">בינוני</span>
                <span class="urgency-tag blue">חלש</span>
            </div>
        </div>
        <div class="alert-toolbar">
            <button class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">הכל</button>
            <button class="filter-chip red" data-filter="5" onclick="setFilter(5, this)">ודאי</button>
            <button class="filter-chip orange" data-filter="4" onclick="setFilter(4, this)">חזק</button>
            <button class="filter-chip yellow" data-filter="3" onclick="setFilter(3, this)">בינוני</button>
            <button class="filter-chip blue" data-filter="2" onclick="setFilter(2, this)">חלש</button>
            <button class="filter-chip purple" data-filter="anarchist" onclick="setFilter('anarchist', this)">אנרכיסטים</button>
            <div class="toggle-container">
                <div class="toggle-switch active" id="anarchistToggle" onclick="toggleAnarchist()"></div>
                <span>אנרכיסטים</span>
            </div>
            <input type="text" class="search-input" id="searchInput" placeholder="חיפוש..." oninput="applyFilters()">
        </div>
        <div class="timeline-graph">
            <div class="timeline-label">פעילות 24 שעות</div>
            <div class="timeline-bars" id="timelineBars"></div>
            <div class="timeline-hours" id="timelineHours"></div>
        </div>
        <div class="panel-body" id="alertFeed">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>סורק ערוצים...</span>
            </div>
        </div>
    </div>

    <!-- CONFIG PANEL -->
    <div class="panel config-panel">
        <div class="panel-header">
            <span class="panel-title">מערכת</span>
            <div class="panel-indicator"></div>
        </div>
        <div class="panel-body">
            <div class="config-item"><span class="config-key">גזרה</span><span class="config-val">כביש 443</span></div>
            <div class="config-item"><span class="config-key">רדיוס</span><span class="config-val">15 ק"מ</span></div>
            <div class="config-item"><span class="config-key">מרכז</span><span class="config-val">31.87N 35.12E</span></div>
            <div class="config-item"><span class="config-key">סריקה</span><span class="config-val">10 דק'</span></div>
            <div class="config-item"><span class="config-key">AI</span><span class="config-val">GEMINI 2.0</span></div>
            <div class="config-item"><span class="config-key">שמירה</span><span class="config-val">72 שעות</span></div>
            <div class="config-item"><span class="config-key">רענון</span><span class="config-val" id="nextRefresh">30s</span></div>
        </div>
    </div>

</div>

<!-- HISTORY OVERLAY -->
<div class="history-overlay" id="historyOverlay">
    <div class="history-header">
        <div class="history-title">יומן היסטורי</div>
        <button class="history-close" onclick="toggleHistory()">סגור ESC</button>
    </div>
    <div class="history-stat-bar" id="historyStats"></div>
    <div class="history-filters">
        <input type="text" class="history-search" id="historySearch" placeholder="חיפוש בהיסטוריה..." oninput="renderHistory()">
        <button class="filter-chip active" data-hfilter="all" onclick="setHistoryFilter('all', this)">הכל</button>
        <button class="filter-chip red" data-hfilter="5" onclick="setHistoryFilter(5, this)">ודאי</button>
        <button class="filter-chip orange" data-hfilter="4" onclick="setHistoryFilter(4, this)">חזק</button>
        <button class="filter-chip yellow" data-hfilter="3" onclick="setHistoryFilter(3, this)">בינוני</button>
        <button class="filter-chip blue" data-hfilter="2" onclick="setHistoryFilter(2, this)">חלש</button>
    </div>
    <div class="history-body" id="historyBody">
        <div class="loading-state"><div class="loading-spinner"></div><span>טוען היסטוריה...</span></div>
    </div>
</div>

<!-- Refresh Bar -->
<div class="refresh-bar" id="refreshBar"></div>

<!-- Credit Footer -->
<div class="credit-footer" id="creditFooter">
    <a href="https://wa.me/972542012000" target="_blank">נבנה ע"י אלחי פיין | 054-201-2000</a>
</div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
// ═══════════════════════════════════════
// MABAT 443 - DASHBOARD ENGINE v2
// ═══════════════════════════════════════

const FIREBASE_URL = 'https://project-8874611670473210078-default-rtdb.europe-west1.firebasedatabase.app';
const SECTOR_CENTER = { lat: 31.870, lng: 35.120 };
const REFRESH_INTERVAL = 30000;

// KEY VILLAGES - highlighted on map with larger markers + sector history
const KEY_VILLAGES = [
    { he: "בית עור א-תחתא", lat: 31.870, lng: 35.120, priority: 'P1', pop: '~5,000',
      history: 'צמוד לציר 443. מוקד עימותים קבוע, ירי ואבנים לעבר כלי רכב. נקודת חנק מרכזית.',
      threats: ['ירי', 'אבנים', 'חסימות'] },
    { he: "בית עור אל-פוקא", lat: 31.878, lng: 35.130, priority: 'P1', pop: '~3,500',
      history: 'כפר מעל ציר 443. היסטוריה של השלכת אבנים לעבר מתנחלים ורכבים צבאיים.',
      threats: ['אבנים', 'בקת"ב'] },
    { he: "ח'רבת אל-מיסבאח", lat: 31.852, lng: 35.098, priority: 'P1', pop: '~1,200',
      history: 'יישוב קטן על הציר. חיכוכי קרקעות עם מתנחלים. מבנים לא חוקיים.',
      threats: ['קרקעות', 'מבנים'] },
    { he: "ספא", lat: 31.878, lng: 35.087, priority: 'P2', pop: '~3,000',
      history: 'כפר צפונית לציר. חסימות כביש חוזרות בצמיגים בוערים. מוקד הפגנות.',
      threats: ['חסימות', 'הפגנות', 'צמיגים'] },
    { he: "מידיה", lat: 31.838, lng: 35.110, priority: 'P1', pop: '~3,200',
      history: 'צמוד לציר 443 דרומית. פעילות חשודה ליד הגדר. סריקות תכופות.',
      threats: ['פעילות חשודה', 'גדר'] },
    { he: "בית סירא", lat: 31.848, lng: 35.075, priority: 'P2', pop: '~4,500',
      history: 'מערבית לציר. עימותים עם כוחות ביטחון בכניסה לכפר. בקת"ב ואבנים.',
      threats: ['עימותים', 'בקת"ב', 'אבנים'] },
    { he: "בית ליקיא", lat: 31.833, lng: 35.080, priority: 'P2', pop: '~7,000',
      history: 'כפר גדול מערבית-דרומית. פשיטות ומעצרים תכופים. ערוץ טלגרם מקומי פעיל.',
      threats: ['מעצרים', 'פשיטות'] },
    { he: "בית דורס (בן דרוס)", lat: 31.825, lng: 35.095, priority: 'P1', pop: '~2,000',
      history: 'על הציר. נקודת חיכוך עם מתנחלים. הפגנות שבועיות נגד ההתנחלויות.',
      threats: ['מתנחלים', 'הפגנות'] },
    { he: "קיבא", lat: 31.810, lng: 35.090, priority: 'P1', pop: '~4,000',
      history: 'ליד גדר ההפרדה. ניסיונות חדירה. היסטוריה ביטחונית עמוסה.',
      threats: ['חדירות', 'גדר'] },
    { he: "רנתיס", lat: 31.815, lng: 35.060, priority: 'P1', pop: '~2,500',
      history: 'כפר דרום-מערבי. פעילות אנרכיסטים ובצלם. תיעוד נגד צה"ל.',
      threats: ['אנרכיסטים', 'תיעוד'] },
    { he: "דיר איביע", lat: 31.893, lng: 35.155, priority: 'P2', pop: '~4,000',
      history: 'צפונית לציר. ערוץ טלגרם מקומי. פשיטות צבאיות תכופות.',
      threats: ['פשיטות', 'מעצרים'] },
    { he: "כפר ניעמה", lat: 31.905, lng: 35.120, priority: 'P2', pop: '~2,800',
      history: 'צפונית. מוקד השלכת אבנים ועימותים עם כוחות.',
      threats: ['אבנים', 'עימותים'] },
    { he: "בילעין", lat: 31.900, lng: 35.080, priority: 'P2', pop: '~2,000',
      history: 'מוכר בינלאומית מהפגנות שבועיות נגד הגדר. מוקד ISM ואנרכיסטים.',
      threats: ['הפגנות', 'אנרכיסטים', 'ISM'] },
];

const P1_LOCATIONS = [
    { name: "Beit Ur al-Tahta", he: "בית עור א-תחתא", lat: 31.870, lng: 35.120 },
    { name: "Beit Ur al-Fauqa", he: "בית עור אל-פוקא", lat: 31.878, lng: 35.130 },
    { name: "Khirbet al-Misbah", he: "ח'רבת אל-מיסבאח", lat: 31.852, lng: 35.098 },
    { name: "Midya", he: "מידיה", lat: 31.838, lng: 35.110 },
    { name: "Budrus", he: "בית דורס (בן דרוס)", lat: 31.825, lng: 35.095 },
    { name: "Qibya", he: "קיבא", lat: 31.810, lng: 35.090 },
    { name: "Rantis", he: "רנתיס", lat: 31.815, lng: 35.060 },
];

const P2_LOCATIONS = [
    { name: "Deir Ibzia", he: "דיר איביע", lat: 31.893, lng: 35.155 },
    { name: "Kafr Nimah", he: "כפר ניעמה", lat: 31.905, lng: 35.120 },
    { name: "Safa", he: "ספא", lat: 31.878, lng: 35.087 },
    { name: "Bilin", he: "בילעין", lat: 31.900, lng: 35.080 },
    { name: "Beit Sira", he: "בית סירא", lat: 31.848, lng: 35.075 },
    { name: "Beit Liqya", he: "בית ליקיא", lat: 31.833, lng: 35.080 },
    { name: "Ein Arik", he: "עין עריכ", lat: 31.895, lng: 35.175 },
    { name: "Ein Qiniya", he: "עין קיניא", lat: 31.905, lng: 35.195 },
    { name: "Tira", he: "טירה", lat: 31.845, lng: 35.155 },
];

const P3_LOCATIONS = [
    { name: "Route 443", he: "כביש 443", lat: 31.870, lng: 35.120, type: 'route' },
    { name: "Route 446", he: "כביש 446", lat: 31.920, lng: 35.070, type: 'route' },
    { name: "Maccabim CP", he: "מחסום מכבים", lat: 31.850, lng: 35.050, type: 'checkpoint' },
];

const ISRAELI_LOCATIONS = [
    { name: "Modi'in Illit", he: "מודיעין עילית", lat: 31.930, lng: 35.050 },
    { name: "Givat Zeev", he: "גבעת זאב", lat: 31.860, lng: 35.170 },
    { name: "Beit Horon", he: "בית חורון", lat: 31.860, lng: 35.148 },
];

const מקורות = [
    { id: 'deiribzi', name: 'דיר איביע', type: 'local', tg: 'deiribzi' },
    { id: 'beit_liqya', name: 'בית ליקיא', type: 'local', tg: 'beit_liqya' },
    { id: 'beit_sira', name: 'בית סירא', type: 'local', tg: 'beit_sira' },
    { id: 'ramallahnew', name: 'רמאללה חדשות', type: 'regional', tg: 'ramallahnew' },
    { id: 'ramallahmix1', name: 'רמאללה מיקס', type: 'regional', tg: 'ramallahmix1' },
    { id: 'QudsN', name: 'רשת קודס', type: 'national', tg: 'QudsN' },
    { id: 'palinfo', name: 'מרכז תקשורת', type: 'national', tg: 'palaborz' },
    { id: 'PalestineResist', name: 'Resistance News', type: 'national', tg: 'PalestineResist' },
    { id: 'google-news', name: 'Google News', type: 'news', url: 'https://news.google.com' },
];

// ═══════ STATE ═══════
let map;
let alertMarkers = [];
let newsData = {};
let allNewsData = {};
let summaryData = null;
let metaData = null;
let activeFilter = 'all';
let historyFilter = 'all';
let knownIds = new Set();
let isFirstLoad = true;
let mapIsFullscreen = false;
let showAnarchists = true;

// Anarchist/activist keywords
const ANARCHIST_KEYWORDS = [
    'anarchist', 'activist', 'solidarity', 'protest',
    'ISM', 'B\'Tselem', 'breaking the silence',
    'international', 'demonstration', 'confrontation',
    'left-wing', 'peace now',
    'ناشط', 'ناشطين', 'تضامن', 'متظاهرين', 'اجانب',
    'اسرائيليين ضد', 'سلام الان',
    'פעיל', 'פעילי', 'אנרכיסט', 'אנרכיסטים',
    'שוברים שתיקה', 'בצלם', 'שמאל',
    'פעילי שמאל', 'מפגינים', 'סולידריות',
    'ISM', 'בינלאומיים', 'שלום עכשיו',
    'מחאה', 'הפגנה', 'פעילות מחאה',
];

// ═══════ CLOCK ═══════
function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    const s = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('clock').textContent = `${h}:${m}:${s}`;

    const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const months = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
    document.getElementById('dateDisplay').textContent = `יום ${days[now.getDay()]} | ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
}

// ═══════ SOURCE URL HELPER ═══════
function getSourceUrl(sourceName) {
    if (!sourceName) return '';
    const sourceMap = {};
    מקורות.forEach(src => {
        sourceMap[src.id] = src.tg ? `https://t.me/${src.tg}` : (src.url || '');
        sourceMap[src.name] = src.tg ? `https://t.me/${src.tg}` : (src.url || '');
    });
    return sourceMap[sourceName] || '';
}

// ═══════ LOCATION POPUP BUILDER ═══════
function buildLocationPopup(loc, priority, color) {
    const mapsLink = `https://www.google.com/maps?q=${loc.lat},${loc.lng}`;
    return `<div style="direction:rtl;text-align:right;min-width:160px;">` +
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">` +
            `<b style="color:${color};font-size:13px;">${loc.he}</b>` +
            `<span style="font-size:9px;padding:1px 6px;border:1px solid ${color};border-radius:3px;color:${color};letter-spacing:1px;">${priority}</span>` +
        `</div>` +
        `<div style="color:#9ab0c8;font-size:10px;margin-bottom:4px;">${loc.lat.toFixed(3)}N, ${loc.lng.toFixed(3)}E</div>` +
        `<div style="text-align:center;margin-top:4px;">` +
            `<a href="${mapsLink}" target="_blank" style="color:#00d4ff;font-size:10px;text-decoration:none;">📍 פתח במפות Google</a>` +
        `</div>` +
    `</div>`;
}

// ═══════ MAP ═══════
function initMap() {
    map = L.map('map', {
        center: [SECTOR_CENTER.lat, SECTOR_CENTER.lng],
        zoom: 12,
        zoomControl: false,
        attributionControl: false
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
    }).addTo(map);

    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 15000, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.03, weight: 1, dashArray: '8, 8', opacity: 0.3
    }).addTo(map);

    L.circle([SECTOR_CENTER.lat, SECTOR_CENTER.lng], {
        radius: 200, color: '#00d4ff', fillColor: '#00d4ff',
        fillOpacity: 0.3, weight: 2
    }).addTo(map);

    // Arab villages - orange
    P1_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 6, color: '#ff8800', fillColor: '#ff8800', fillOpacity: 0.4, weight: 1.5
        }).bindTooltip(loc.he, { className: 'dark-tooltip' })
          .bindPopup(buildLocationPopup(loc, 'P1', '#ff8800'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    P2_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 5, color: '#ff8800', fillColor: '#ff8800', fillOpacity: 0.3, weight: 1
        }).bindTooltip(loc.he, { className: 'dark-tooltip' })
          .bindPopup(buildLocationPopup(loc, 'P2', '#ff8800'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // Routes & checkpoints - cyan dashed
    P3_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 4, color: '#00d4ff', fillColor: '#00d4ff', fillOpacity: 0.3, weight: 1
        }).bindTooltip(loc.he, { className: 'dark-tooltip' })
          .bindPopup(buildLocationPopup(loc, 'P3', '#00d4ff'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // Israeli settlements - blue
    ISRAELI_LOCATIONS.forEach(loc => {
        L.circleMarker([loc.lat, loc.lng], {
            radius: 6, color: '#4488ff', fillColor: '#4488ff', fillOpacity: 0.4, weight: 1.5
        }).bindTooltip(loc.he, { className: 'dark-tooltip' })
          .bindPopup(buildLocationPopup(loc, 'ישוב', '#4488ff'), { className: 'dark-tooltip', maxWidth: 280 })
          .addTo(map);
    });

    // KEY VILLAGES - larger highlighted markers with sector history popups (all orange = Arab villages)
    KEY_VILLAGES.forEach(loc => {
        const pColor = '#ff8800';
        const marker = L.circleMarker([loc.lat, loc.lng], {
            radius: 8,
            color: pColor,
            fillColor: pColor,
            fillOpacity: 0.5,
            weight: 2
        }).addTo(map);

        marker.bindTooltip(loc.he, { className: 'dark-tooltip' });

        // Rich popup on click with sector history + live data
        marker.on('click', function() {
            const count24h = getVillageReportCount(loc, 24);
            const count72h = getVillageReportCount(loc, 72);
            const lastEvent = getVillageLastEvent(loc);
            const threatTags = (loc.threats || []).map(t =>
                `<span style="display:inline-block;padding:1px 5px;margin:1px;border-radius:3px;background:rgba(255,0,64,0.15);border:1px solid rgba(255,0,64,0.3);font-size:9px;color:#ff8800;">${t}</span>`
            ).join('');
            const mapsLink = `https://www.google.com/maps?q=${loc.lat},${loc.lng}`;

            const popupHtml = `<div style="direction:rtl;text-align:right;min-width:200px;max-width:260px;">` +
                `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">` +
                    `<b style="color:${pColor};font-size:14px;">${loc.he}</b>` +
                    `<span style="font-size:9px;padding:1px 6px;border:1px solid ${pColor};border-radius:3px;color:${pColor};letter-spacing:1px;">${loc.priority}</span>` +
                `</div>` +
                (loc.pop ? `<div style="color:#9ab0c8;font-size:10px;margin-bottom:4px;">אוכלוסייה: ${loc.pop}</div>` : '') +
                `<div style="color:#e0e8f0;font-size:11px;line-height:1.4;margin-bottom:6px;border-right:2px solid ${pColor};padding-right:6px;">${loc.history || ''}</div>` +
                `<div style="margin-bottom:5px;">${threatTags}</div>` +
                `<div style="border-top:1px solid #0f3460;padding-top:4px;display:flex;gap:12px;">` +
                    `<div style="text-align:center;">` +
                        `<div style="font-size:9px;color:#9ab0c8;">24 שע'</div>` +
                        `<b style="color:${count24h > 0 ? '#ff8800' : '#00ff88'};font-size:14px;">${count24h}</b>` +
                    `</div>` +
                    `<div style="text-align:center;">` +
                        `<div style="font-size:9px;color:#9ab0c8;">72 שע'</div>` +
                        `<b style="color:${count72h > 0 ? '#ffd000' : '#00ff88'};font-size:14px;">${count72h}</b>` +
                    `</div>` +
                    `<div style="flex:1;text-align:center;">` +
                        `<div style="font-size:9px;color:#9ab0c8;">אחרון</div>` +
                        `<span style="color:#e0e8f0;font-size:10px;">${lastEvent}</span>` +
                    `</div>` +
                `</div>` +
                `<div style="border-top:1px solid #0f3460;margin-top:6px;padding-top:6px;text-align:center;">` +
                    `<a href="${mapsLink}" target="_blank" style="color:#00d4ff;font-size:10px;text-decoration:none;">📍 פתח במפות Google</a>` +
                `</div>` +
            `</div>`;
            this.unbindPopup();
            this.bindPopup(popupHtml, { className: 'dark-tooltip', maxWidth: 280 }).openPopup();
        });

        // Outer pulse ring
        L.circleMarker([loc.lat, loc.lng], {
            radius: 14,
            color: pColor,
            fillColor: 'transparent',
            fillOpacity: 0,
            weight: 1,
            opacity: 0.3,
            dashArray: '4,4'
        }).addTo(map);
    });

    const route443 = [
        [31.840, 35.040], [31.845, 35.055], [31.850, 35.070],
        [31.855, 35.085], [31.860, 35.095], [31.865, 35.108],
        [31.870, 35.120], [31.875, 35.135], [31.878, 35.148],
        [31.880, 35.160], [31.882, 35.175]
    ];
    L.polyline(route443, {
        color: '#00d4ff', weight: 2, opacity: 0.5, dashArray: '10, 6'
    }).addTo(map);
}

function toggleMapFullscreen() {
    const panel = document.getElementById('mapPanel');
    const btn = document.getElementById('mapBtn');
    mapIsFullscreen = !mapIsFullscreen;

    if (mapIsFullscreen) {
        panel.classList.add('fullscreen');
        btn.innerHTML = '&#x26F6; מזער';
    } else {
        panel.classList.remove('fullscreen');
        btn.innerHTML = '&#x26F6; הרחב';
    }
    setTimeout(() => map.invalidateSize(), 400);
}

function updateMapMarkers(news) {
    alertMarkers.forEach(m => map.removeLayer(m));
    alertMarkers = [];

    // Build threat level per village (highest urgency near each village)
    const allVillages = [...KEY_VILLAGES, ...P1_LOCATIONS.map(l => ({...l, he: l.he})), ...P2_LOCATIONS.map(l => ({...l, he: l.he}))];
    const villageThreat = {};
    Object.values(news).forEach(item => {
        if (!item.coordinates) return;
        allVillages.forEach(v => {
            const dlat = Math.abs((item.coordinates.lat || 0) - v.lat);
            const dlng = Math.abs((item.coordinates.lon || item.coordinates.lng || 0) - v.lng);
            if (dlat < 0.015 && dlng < 0.015) {
                const key = `${v.lat},${v.lng}`;
                if (!villageThreat[key] || item.urgency > villageThreat[key]) {
                    villageThreat[key] = item.urgency;
                }
            }
        });
    });

    // Add threat rings around villages
    Object.entries(villageThreat).forEach(([key, urgency]) => {
        const [lat, lng] = key.split(',').map(Number);
        const threatColors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#666' };
        const ringColor = threatColors[urgency] || '#666';
        const ring = L.circleMarker([lat, lng], {
            radius: 16, color: ringColor, fillColor: 'transparent',
            fillOpacity: 0, weight: 2.5, opacity: 0.7,
            dashArray: urgency >= 4 ? '' : '6,4',
            className: urgency >= 4 ? 'threat-ring-pulse' : ''
        }).addTo(map);
        alertMarkers.push(ring);
    });

    Object.values(news).forEach(item => {
        if (!item.coordinates) return;
        const colors = { 5: '#ff0040', 4: '#ff8800', 3: '#ffd000', 2: '#4488ff', 1: '#666' };
        const color = colors[item.urgency] || '#666';
        const size = item.urgency >= 4 ? 12 : item.urgency >= 3 ? 9 : 7;

        const marker = L.circleMarker(
            [item.coordinates.lat, item.coordinates.lon || item.coordinates.lng],
            { radius: size, color, fillColor: color, fillOpacity: 0.6, weight: 2 }
        ).bindPopup(`
            <div style="direction:rtl; font-family: 'Rajdhani', sans-serif; max-width: 250px;">
                <b style="color:${color};">[${item.urgencyLabel || 'ALERT'}]</b><br>
                <b>${escapeHtml(item.title || '')}</b><br>
                <small>${escapeHtml(item.snippet || '')}</small><br>
                <small style="color:#888;">${escapeHtml(item.source)} | ${formatTime(item.timestamp)}</small>
            </div>
        `, { className: 'dark-tooltip', maxWidth: 280 }).addTo(map);

        alertMarkers.push(marker);
    });
}

// ═══════ FETCH DATA ═══════
async function fetchData() {
    try {
        const [newsRes, summaryRes, metaRes] = await Promise.all([
            fetch(`${FIREBASE_URL}/auto-news.json`),
            fetch(`${FIREBASE_URL}/world-news-summary/current.json`),
            fetch(`${FIREBASE_URL}/metadata.json`)
        ]);

        const news = await newsRes.json();
        const summary = await summaryRes.json();
        const meta = await metaRes.json();

        // Skip Firebase error responses
        if (news && !news.error) {
            // Normalize urgencyScore → urgency, and ensure timestamp
            Object.values(news).forEach(item => {
                if (!item.urgency && item.urgencyScore) item.urgency = item.urgencyScore;
                if (!item.timestamp) {
                    if (item.publishedAt) item.timestamp = new Date(item.publishedAt).getTime();
                    else if (item.date) item.timestamp = new Date(item.date).getTime();
                    else if (item.fetchedAt) item.timestamp = new Date(item.fetchedAt).getTime();
                }
            });
            // Detect new alerts for flash
            if (!isFirstLoad) {
                const newIds = Object.keys(news);
                let hasNewRed = false;
                newIds.forEach(id => {
                    if (!knownIds.has(id) && news[id].urgency >= 5) hasNewRed = true;
                });
                if (hasNewRed) triggerRedAlert();
            }
            newsData = news;
            allNewsData = { ...allNewsData, ...news };
            Object.keys(news).forEach(id => knownIds.add(id));
        }
        if (summary && !summary.error) summaryData = summary;
        if (meta && !meta.error) metaData = meta;

        isFirstLoad = false;
        document.getElementById('statusDot').className = 'status-dot';
        document.getElementById('statusText').textContent = 'ONLINE';
        renderAll();
    } catch (error) {
        console.error('Fetch error:', error);
        document.getElementById('statusDot').className = 'status-dot offline';
        document.getElementById('statusText').textContent = 'שגיאה';
    }
}

// ═══════ RED ALERT ═══════
function triggerRedAlert() {
    const flash = document.getElementById('redAlertFlash');
    flash.classList.remove('active');
    void flash.offsetWidth; // reflow
    flash.classList.add('active');

    // Audio beep
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'square';
        gain.gain.value = 0.15;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
        osc.stop(ctx.currentTime + 0.5);
    } catch (e) {}
}

// ═══════ RENDER ALL ═══════
function renderAll() {
    renderAlerts();
    renderSummary();
    renderStats();
    renderSources();
    renderThreatLevel();
    renderMeta();
    renderTimeline();
    updateMapMarkers(newsData);
}

// ═══════ FILTERS ═══════
function setFilter(level, btn) {
    activeFilter = level;
    document.querySelectorAll('.alert-toolbar .filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderAlerts();
}

function applyFilters() {
    renderAlerts();
}

function toggleAnarchist() {
    showAnarchists = !showAnarchists;
    const toggle = document.getElementById('anarchistToggle');
    toggle.classList.toggle('active', showAnarchists);
    renderAlerts();
}

function isAnarchistEvent(item) {
    const text = ((item.title || '') + ' ' + (item.snippet || '') + ' ' + (item.fullText || '')).toLowerCase();
    return ANARCHIST_KEYWORDS.some(kw => text.includes(kw.toLowerCase()));
}

function setHistoryFilter(level, btn) {
    historyFilter = level;
    document.querySelectorAll('.history-filters .filter-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    renderHistory();
}

// ═══════ RENDER ALERTS ═══════
function renderAlerts() {
    const feed = document.getElementById('alertFeed');
    let items = Object.values(newsData);
    const searchText = (document.getElementById('searchInput').value || '').toLowerCase();

    // Tag anarchist events
    items.forEach(i => { i._isAnarchist = isAnarchistEvent(i); });

    // Filter by anarchist toggle
    if (!showAnarchists) {
        items = items.filter(i => !i._isAnarchist);
    }

    if (activeFilter === 'anarchist') {
        items = items.filter(i => i._isAnarchist);
    } else if (activeFilter !== 'all') {
        items = items.filter(i => i.urgency === activeFilter);
    }
    if (searchText) {
        items = items.filter(i =>
            (i.title || '').toLowerCase().includes(searchText) ||
            (i.snippet || '').toLowerCase().includes(searchText) ||
            (i.fullText || '').toLowerCase().includes(searchText) ||
            (i.source || '').toLowerCase().includes(searchText)
        );
    }

    if (items.length === 0) {
        const scanTime = metaData && metaData.lastRun ? formatTime(metaData.lastRun) : '--:--';
        feed.innerHTML = `<div class="empty-state" style="padding:40px;">
            <div style="font-size:28px;margin-bottom:10px;opacity:0.3;">&#x2714;</div>
            ${searchText || activeFilter !== 'all'
                ? '<span>אין התראות תואמות</span><br><small style="color:var(--text-dim);">' + (searchText ? 'נסה חיפוש אחר' : 'נסה פילטר אחר') + '</small>'
                : '<span style="color:var(--green);font-size:14px;font-weight:600;">הגזרה שקטה</span><br><small style="color:var(--text-dim);line-height:2;">המערכת סורקת 8 ערוצי טלגרם + Google News כל 10 דקות<br>סריקה אחרונה: ' + scanTime + '<br>לחץ <b style="color:var(--yellow);">הדגמה</b> לתצוגת נתונים לדוגמה</small>'
            }
        </div>`;
        return;
    }

    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    feed.innerHTML = items.map(item => {
        // Location: prefer locationHe from backend, fallback to matchedLocations
        const locationName = item.locationHe || (item.matchedLocations ? item.matchedLocations.join(', ') : '') || '';
        const hasCoords = item.coordinates && (item.coordinates.lat || item.coordinates.lon || item.coordinates.lng);
        const coordLat = hasCoords ? item.coordinates.lat : '';
        const coordLng = hasCoords ? (item.coordinates.lon || item.coordinates.lng) : '';
        const locationTag = hasCoords
            ? `<a href="javascript:void(0)" onclick="flyToAlertLocation(${coordLat},${coordLng},event)" style="color:#00d4ff;font-size:10px;text-decoration:none;display:inline-flex;align-items:center;gap:3px;margin-top:3px;cursor:pointer;">📍 ${escapeHtml(locationName || 'הצג במפה')}</a>`
            : (locationName
                ? `<span style="color:#9ab0c8;font-size:10px;display:inline-flex;align-items:center;gap:3px;margin-top:3px;">📍 ${escapeHtml(locationName)}</span>`
                : '');
        // Source link
        const sourceUrl = item.sourceUrl || getSourceUrl(item.source);
        const sourceTag = sourceUrl
            ? `<a href="${escapeHtml(sourceUrl)}" target="_blank" onclick="event.stopPropagation();" class="alert-source" style="text-decoration:none;color:var(--text-dim);">${escapeHtml(item.source || 'N/A')}</a>`
            : `<span class="alert-source">${escapeHtml(item.source || 'N/A')}</span>`;
        return `
        <div class="alert-item" onclick="toggleAlertExpand(this)">
            <div class="alert-row">
                <span class="alert-time">${formatTime(item.timestamp)}</span>
                <div class="alert-urgency ${item._isAnarchist ? 'urgency-anarchist' : 'urgency-' + (item.urgency || 1)}"></div>
                <div class="alert-content">
                    <div class="alert-title">${escapeHtml(item.title || 'N/A')}${locationName ? ' <span style="color:#00d4ff;font-weight:normal;font-size:11px;">(' + escapeHtml(locationName) + ')</span>' : ''}</div>
                    <div class="alert-snippet">${escapeHtml((item.snippet || item.fullText || '').substring(0, 120))}</div>
                    ${locationTag}
                </div>
                ${sourceTag}
            </div>
            <div class="alert-full-text" style="display:none;">${escapeHtml(item.fullText || item.snippet || '')}</div>
            <div class="alert-meta-row" style="display:none;">
                <span>${formatDateTime(item.timestamp)}</span>
                ${locationName ? '<span>📍 ' + escapeHtml(locationName) + '</span>' : ''}
                ${item.matchedKeywords ? '<span>KW: ' + escapeHtml(item.matchedKeywords.join(', ')) + '</span>' : ''}
                ${item.distance ? '<span>' + item.distance.toFixed(1) + ' km</span>' : ''}
                ${hasCoords ? '<a href="javascript:void(0)" onclick="flyToAlertLocation(' + coordLat + ',' + coordLng + ',event)" style="color:#00d4ff;text-decoration:none;cursor:pointer;">🗺️ הצג במפה</a>' : ''}
            </div>
        </div>
    `}).join('');
}

function toggleAlertExpand(el) {
    const fullText = el.querySelector('.alert-full-text');
    const metaRow = el.querySelector('.alert-meta-row');
    const isExpanded = el.classList.contains('expanded');

    // Close all others
    document.querySelectorAll('.alert-item.expanded').forEach(item => {
        if (item !== el) {
            item.classList.remove('expanded');
            item.querySelector('.alert-full-text').style.display = 'none';
            item.querySelector('.alert-meta-row').style.display = 'none';
        }
    });

    if (isExpanded) {
        el.classList.remove('expanded');
        fullText.style.display = 'none';
        metaRow.style.display = 'none';
    } else {
        el.classList.add('expanded');
        fullText.style.display = 'block';
        metaRow.style.display = 'flex';
    }
}

function scrollToAlerts() {
    const alertPanel = document.getElementById('alertFeedPanel');
    alertPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    // Brief highlight flash
    alertPanel.style.boxShadow = '0 0 20px var(--cyan)';
    setTimeout(() => { alertPanel.style.boxShadow = ''; }, 1500);
}

function flyToAlertLocation(lat, lng, event) {
    event.stopPropagation();
    if (mapIsFullscreen) toggleMapFullscreen();
    const mapEl = document.getElementById('mapPanel');
    mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
        map.flyTo([lat, lng], 15, { duration: 1 });
        // Flash a temporary marker
        const pulse = L.circleMarker([lat, lng], {
            radius: 20, color: '#00d4ff', fillColor: '#00d4ff',
            fillOpacity: 0.3, weight: 2
        }).addTo(map);
        setTimeout(() => map.removeLayer(pulse), 3000);
    }, 400);
}

// ═══════ RENDER TIMELINE ═══════
function renderTimeline() {
    const container = document.getElementById('timelineBars');
    const hoursContainer = document.getElementById('timelineHours');
    const items = Object.values(newsData);
    const now = Date.now();
    const hours = 24;
    const buckets = Array.from({ length: hours }, () => ({ count: 0, maxUrg: 0 }));

    items.forEach(item => {
        const age = (now - (item.timestamp || 0)) / (1000 * 60 * 60);
        const bucket = Math.min(hours - 1, Math.max(0, Math.floor(age)));
        buckets[bucket].count++;
        buckets[bucket].maxUrg = Math.max(buckets[bucket].maxUrg, item.urgency || 1);
    });

    const maxCount = Math.max(1, ...buckets.map(b => b.count));

    // Reverse so newest is on the right
    const reversed = [...buckets].reverse();

    container.innerHTML = reversed.map((b, i) => {
        const h = Math.max(2, (b.count / maxCount) * 35);
        const urgClass = b.maxUrg >= 5 ? 'has-red' : b.maxUrg >= 4 ? 'has-orange' : b.maxUrg >= 3 ? 'has-yellow' : b.count > 0 ? 'has-blue' : '';
        return `<div class="timeline-bar ${urgClass}" style="height:${h}px;" title="${b.count} alerts"></div>`;
    }).join('');

    // Hour labels
    const nowHour = new Date().getHours();
    hoursContainer.innerHTML = '';
    for (let i = 0; i < hours; i += 6) {
        const label = String((nowHour - hours + 1 + i + 24) % 24).padStart(2, '0') + ':00';
        const span = document.createElement('span');
        span.textContent = label;
        hoursContainer.appendChild(span);
    }
}

// ═══════ RENDER SUMMARY ═══════
function renderSummary() {
    const body = document.getElementById('summaryBody');
    if (!summaryData || !summaryData.summary) {
        body.innerHTML = '<div class="empty-state">ממתין לניתוח AI<br><small>מתעדכן כל שעה</small></div>';
        return;
    }
    body.innerHTML = `
        <div class="summary-text">${escapeHtml(summaryData.summary)}</div>
        <div class="summary-meta">
            <span>${summaryData.aiProvider || 'Gemini'} AI</span>
            <span>${formatDateTime(summaryData.generatedAt)}</span>
        </div>
    `;
}

// ═══════ RENDER STATS ═══════
function renderStats() {
    const items = Object.values(newsData);
    const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    const sources = new Set();

    items.forEach(item => {
        counts[item.urgency || 1]++;
        if (item.source) sources.add(item.source);
    });

    document.getElementById('statTotal').textContent = items.length;
    document.getElementById('statRed').textContent = counts[5];
    document.getElementById('statOrange').textContent = counts[4];
    document.getElementById('statYellow').textContent = counts[3];
    document.getElementById('statBlue').textContent = counts[2] + counts[1];
    document.getElementById('statSources').textContent = sources.size;
    document.getElementById('alertCount').textContent = items.length;
}

// ═══════ RENDER רמת איום ═══════
function renderThreatLevel() {
    const items = Object.values(newsData);
    let maxUrgency = 0;
    const recentCutoff = Date.now() - (6 * 60 * 60 * 1000);

    items.forEach(item => {
        if (item.timestamp > recentCutoff && item.urgency > maxUrgency) {
            maxUrgency = item.urgency;
        }
    });

    const circle = document.getElementById('threatCircle');
    const num = document.getElementById('threatNum');
    const label = document.getElementById('threatLabel');

    const levels = {
        0: { class: 'level-green', label: 'תקין', color: '#00ff88' },
        1: { class: 'level-gray', label: 'מינימלי', color: '#666' },
        2: { class: 'level-blue', label: 'חלש', color: '#4488ff' },
        3: { class: 'level-yellow', label: 'בינוני', color: '#ffd000' },
        4: { class: 'level-orange', label: 'חזק', color: '#ff8800' },
        5: { class: 'level-red', label: 'ודאי', color: '#ff0040' }
    };

    const level = levels[maxUrgency] || levels[0];
    circle.className = `threat-circle ${level.class}`;
    num.textContent = maxUrgency;
    num.style.color = level.color;
    label.textContent = level.label;
    label.style.color = level.color;

    const bars = document.querySelectorAll('.threat-bar');
    bars.forEach((bar, i) => {
        if (i < maxUrgency) {
            bar.style.background = level.color;
            bar.style.boxShadow = `0 0 8px ${level.color}`;
        } else {
            bar.style.background = 'var(--bg-primary)';
            bar.style.boxShadow = 'none';
        }
    });
}

// ═══════ RENDER מקורות ═══════
function renderSources() {
    const items = Object.values(newsData);
    const sourceCounts = {};
    items.forEach(item => {
        if (item.source) sourceCounts[item.source] = (sourceCounts[item.source] || 0) + 1;
    });

    const list = document.getElementById('sourcesList');
    list.innerHTML = מקורות.map(src => {
        const count = sourceCounts[src.id] || sourceCounts[src.name] || 0;
        const isActive = count > 0;
        const typeLabels = { local: 'LOCAL', regional: 'AREA', national: 'NATL', news: 'NEWS' };
        const link = src.tg ? `https://t.me/${src.tg}` : (src.url || '#');
        return `
            <a class="source-item" href="${link}" target="_blank" style="text-decoration:none;cursor:pointer;">
                <div class="source-dot ${isActive ? 'active' : 'inactive'}"></div>
                <span class="source-name">${src.name}</span>
                <span class="source-type ${src.type}">${typeLabels[src.type]}</span>
                <span class="source-count">${count > 0 ? count : ''}</span>
            </a>
        `;
    }).join('');
}

function renderMeta() {
    if (metaData && metaData.lastRun) {
        document.getElementById('lastScan').textContent = formatTime(metaData.lastRun);
    }
}

// ═══════ HISTORY ═══════
function toggleHistory() {
    const overlay = document.getElementById('historyOverlay');
    overlay.classList.toggle('visible');
    if (overlay.classList.contains('visible')) {
        fetchHistory();
    }
}

async function fetchHistory() {
    try {
        const res = await fetch(`${FIREBASE_URL}/auto-news.json`);
        const data = await res.json();
        if (data) allNewsData = data;
        renderHistory();
    } catch (e) {
        document.getElementById('historyBody').innerHTML = '<div class="empty-state">שגיאה LOADING HISTORY</div>';
    }
}

function renderHistory() {
    const body = document.getElementById('historyBody');
    const searchText = (document.getElementById('historySearch').value || '').toLowerCase();
    let items = Object.values(allNewsData);

    if (historyFilter !== 'all') {
        items = items.filter(i => i.urgency === historyFilter);
    }
    if (searchText) {
        items = items.filter(i =>
            (i.title || '').toLowerCase().includes(searchText) ||
            (i.snippet || '').toLowerCase().includes(searchText) ||
            (i.fullText || '').toLowerCase().includes(searchText) ||
            (i.source || '').toLowerCase().includes(searchText)
        );
    }

    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

    // Stats
    const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
    items.forEach(i => counts[i.urgency || 1]++);
    document.getElementById('historyStats').innerHTML = `
        <div class="history-stat"><strong>${items.length}</strong> סה"כ</div>
        <div class="history-stat"><strong style="color:var(--red)">${counts[5]}</strong> ודאי</div>
        <div class="history-stat"><strong style="color:var(--orange)">${counts[4]}</strong> חזק</div>
        <div class="history-stat"><strong style="color:var(--yellow)">${counts[3]}</strong> בינוני</div>
        <div class="history-stat"><strong style="color:var(--blue)">${counts[2] + counts[1]}</strong> חלש</div>
    `;

    // Group by date
    const groups = {};
    items.forEach(item => {
        const d = new Date(item.timestamp || 0);
        const key = d.toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        if (!groups[key]) groups[key] = [];
        groups[key].push(item);
    });

    if (Object.keys(groups).length === 0) {
        body.innerHTML = '<div class="empty-state">אין רשומות תואמות</div>';
        return;
    }

    const colors = { 5: 'var(--red)', 4: 'var(--orange)', 3: 'var(--yellow)', 2: 'var(--blue)', 1: '#666' };

    body.innerHTML = Object.entries(groups).map(([date, dateItems]) => `
        <div class="history-date-group">
            <div class="history-date-header">${date} (${dateItems.length})</div>
            ${dateItems.map(item => {
                const hHasCoords = item.coordinates && (item.coordinates.lat || item.coordinates.lon || item.coordinates.lng);
                const hCoordLat = hHasCoords ? item.coordinates.lat : '';
                const hCoordLng = hHasCoords ? (item.coordinates.lon || item.coordinates.lng) : '';
                const hMapsLink = hHasCoords ? `https://www.google.com/maps?q=${hCoordLat},${hCoordLng}` : '';
                const hLocName = item.matchedLocations ? item.matchedLocations.join(', ') : '';
                const hLocTag = hLocName
                    ? (hHasCoords
                        ? `<a href="${hMapsLink}" target="_blank" style="color:#00d4ff;font-size:10px;text-decoration:none;">📍 ${escapeHtml(hLocName)}</a>`
                        : `<span style="color:#9ab0c8;font-size:10px;">📍 ${escapeHtml(hLocName)}</span>`)
                    : (hHasCoords
                        ? `<a href="${hMapsLink}" target="_blank" style="color:#00d4ff;font-size:10px;text-decoration:none;">📍 מיקום</a>`
                        : '');
                return `
                <div class="history-item">
                    <span class="history-item-time">${formatTime(item.timestamp)}</span>
                    <div class="history-item-urgency" style="background:${colors[item.urgency] || '#666'}; box-shadow: 0 0 6px ${colors[item.urgency] || '#666'};"></div>
                    <div class="history-item-content">
                        <div class="history-item-title">${escapeHtml(item.title || 'N/A')}</div>
                        <div class="history-item-text">${escapeHtml((item.snippet || item.fullText || '').substring(0, 200))}</div>
                        <div class="history-item-source">${escapeHtml(item.source || 'N/A')} ${hLocTag}</div>
                    </div>
                </div>
            `}).join('')}
        </div>
    `).join('');
}

// ═══════ VILLAGE REPORT COUNT ═══════
function getVillageReportCount(village, hours) {
    const cutoff = Date.now() - (hours * 60 * 60 * 1000);
    const items = Object.values(newsData);
    let count = 0;
    items.forEach(item => {
        if ((item.timestamp || 0) < cutoff) return;
        // Check by coordinates proximity (within ~2km)
        if (item.coordinates) {
            const dlat = Math.abs((item.coordinates.lat || 0) - village.lat);
            const dlng = Math.abs((item.coordinates.lon || item.coordinates.lng || 0) - village.lng);
            if (dlat < 0.02 && dlng < 0.02) { count++; return; }
        }
        // Check by matched location name
        if (item.matchedLocations) {
            const names = item.matchedLocations.join(' ').toLowerCase();
            const heName = village.he.toLowerCase();
            if (names.includes(heName)) { count++; }
        }
    });
    return count;
}

// ═══════ VILLAGE LAST EVENT ═══════
function getVillageLastEvent(village) {
    const items = Object.values(newsData);
    let latest = null;
    items.forEach(item => {
        let match = false;
        if (item.coordinates) {
            const dlat = Math.abs((item.coordinates.lat || 0) - village.lat);
            const dlng = Math.abs((item.coordinates.lon || item.coordinates.lng || 0) - village.lng);
            if (dlat < 0.02 && dlng < 0.02) match = true;
        }
        if (!match && item.matchedLocations) {
            const names = item.matchedLocations.join(' ').toLowerCase();
            if (names.includes(village.he.toLowerCase())) match = true;
        }
        if (match && (!latest || (item.timestamp || 0) > (latest.timestamp || 0))) {
            latest = item;
        }
    });
    if (!latest) return 'אין';
    return formatTime(latest.timestamp);
}

// ═══════ UTILITIES ═══════
function formatTime(ts) {
    if (!ts) return '--:--';
    const d = new Date(ts);
    return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
}

function formatDateTime(ts) {
    if (!ts) return '--';
    const d = new Date(ts);
    return d.toLocaleDateString('he-IL') + ' ' + formatTime(ts);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ═══════ KEYBOARD SHORTCUTS ═══════
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (mapIsFullscreen) toggleMapFullscreen();
        const history = document.getElementById('historyOverlay');
        if (history.classList.contains('visible')) toggleHistory();
    }
    if (e.key === 'f' || e.key === 'F') {
        if (document.activeElement.tagName !== 'INPUT') toggleMapFullscreen();
    }
    if (e.key === 'h' || e.key === 'H') {
        if (document.activeElement.tagName !== 'INPUT') toggleHistory();
    }
});

// ═══════ REFRESH CYCLE ═══════
function startRefreshCycle() {
    const bar = document.getElementById('refreshBar');
    const nextEl = document.getElementById('nextRefresh');
    let elapsed = 0;

    setInterval(() => {
        elapsed += 1000;
        const remaining = Math.max(0, Math.ceil((REFRESH_INTERVAL - elapsed) / 1000));
        nextEl.textContent = `${remaining}s`;
        bar.style.width = `${(elapsed / REFRESH_INTERVAL) * 100}%`;

        if (elapsed >= REFRESH_INTERVAL) {
            elapsed = 0;
            bar.style.width = '0%';
            fetchData();
        }
    }, 1000);
}

// ═══════ LOGIN (handled by inline script above) ═══════

// ═══════ DEMO DATA ═══════
let isDemoMode = false;
let demoTimer = null;
let demoCountdown = 0;
let realNewsData = {};
let realAllNewsData = {};
let realSummaryData = null;
let realMetaData = null;

function loadDemoData() {
    const btn = document.querySelector('[onclick="loadDemoData()"]');

    // Toggle off
    if (isDemoMode) {
        exitDemoMode();
        return;
    }

    // Save real data before overwriting
    realNewsData = { ...newsData };
    realAllNewsData = { ...allNewsData };
    realSummaryData = summaryData;
    realMetaData = metaData;
    isDemoMode = true;

    const now = Date.now();
    const hour = 3600000;

    const demoItems = [
        {
            title: 'ירי לעבר כוח צה"ל בסמוך לבית עור א-תחתא',
            snippet: 'דווח על ירי מנשק קל לעבר כוח צבאי שפעל ליד הכפר. אין נפגעים. כוחות הגיעו למקום.',
            fullText: 'דווח על ירי מנשק קל לעבר כוח צבאי שפעל ליד הכפר בית עור א-תחתא בשעות הלילה. הכוח החזיר אש. אין נפגעים מצד כוחותינו. כוחות נוספים הגיעו לסריקה.',
            source: 'ramallahnew',
            urgency: 5,
            urgencyLabel: 'ודאי',
            timestamp: now - (0.5 * hour),
            coordinates: { lat: 31.870, lon: 35.120 },
            matchedLocations: ['Beit Ur al-Tahta'],
            matchedKeywords: ['ירי', 'כוח צבאי']
        },
        {
            title: 'חסימת כביש 443 - צמיגים בוערים',
            snippet: 'מספר צעירים חסמו את הכביש באזור ספא בצמיגים בוערים ואבנים',
            fullText: 'מספר צעירים פלסטינים חסמו את כביש 443 באזור הכפר ספא בצמיגים בוערים ואבנים. כוחות צה"ל הגיעו לפזר את החסימה. נוצרה פקק תנועה של כ-20 דקות.',
            source: 'QudsN',
            urgency: 4,
            urgencyLabel: 'חזק',
            timestamp: now - (1.2 * hour),
            coordinates: { lat: 31.878, lon: 35.087 },
            matchedLocations: ['Safa', 'Route 443'],
            matchedKeywords: ['חסימה', 'צמיגים']
        },
        {
            title: 'פעילות מחאה של אנרכיסטים בבילעין',
            snippet: 'קבוצת פעילי שמאל ובינלאומיים הגיעו לבילעין להפגנה שבועית נגד גדר ההפרדה',
            fullText: 'כ-30 פעילי שמאל ישראלים ובינלאומיים מ-ISM הגיעו לכפר בילעין להפגנה שבועית. צה"ל פיזר את ההפגנה באמצעות גז מדמיע. מספר פעילים נעצרו.',
            source: 'google-news',
            urgency: 3,
            urgencyLabel: 'בינוני',
            timestamp: now - (2.5 * hour),
            coordinates: { lat: 31.900, lon: 35.080 },
            matchedLocations: ['Bilin'],
            matchedKeywords: ['פעילי שמאל', 'ISM', 'הפגנה']
        },
        {
            title: 'השלכת אבנים לעבר רכבים בצומת בית חורון',
            snippet: 'דווח על השלכת אבנים לעבר רכבים ישראליים באזור צומת בית חורון',
            fullText: 'מספר צעירים מכפר בית עור הפוקא השליכו אבנים לעבר רכבים ישראליים בצומת בית חורון. נגרם נזק לשני רכבים. אין נפגעים בנפש.',
            source: 'palinfo',
            urgency: 4,
            urgencyLabel: 'חזק',
            timestamp: now - (3.8 * hour),
            coordinates: { lat: 31.860, lon: 35.148 },
            matchedLocations: ['Beit Horon'],
            matchedKeywords: ['אבנים', 'רכבים']
        },
        {
            title: 'תנועה חשודה במידיה - סריקה צבאית',
            snippet: 'כוח צבאי ביצע סריקה בכפר מידיה בעקבות דיווח על תנועה חשודה',
            fullText: 'כוח צבאי נכנס לכפר מידיה לביצוע סריקה בעקבות מידע מודיעיני על תנועה חשודה. הסריקה הסתיימה ללא ממצאים חריגים.',
            source: 'ramallahmix1',
            urgency: 3,
            urgencyLabel: 'בינוני',
            timestamp: now - (5 * hour),
            coordinates: { lat: 31.838, lon: 35.110 },
            matchedLocations: ['Midya'],
            matchedKeywords: ['סריקה', 'תנועה חשודה']
        },
        {
            title: 'עימות מקומי בבית סירא',
            snippet: 'עימות בין תושבים מקומיים לכוחות ביטחון באזור הכניסה לכפר',
            fullText: 'עימות מקומי פרץ בכניסה לכפר בית סירא בין צעירים מקומיים לכוחות ביטחון. הושלכו אבנים ובקבוקי תבערה. הכוחות השתמשו באמצעי פיזור.',
            source: 'beit_sira',
            urgency: 4,
            urgencyLabel: 'חזק',
            timestamp: now - (6.5 * hour),
            coordinates: { lat: 31.848, lon: 35.075 },
            matchedLocations: ['Beit Sira'],
            matchedKeywords: ['עימות', 'בקבוקי תבערה']
        },
        {
            title: 'דיווח על רחפן מעל בית ליקיא',
            snippet: 'תושבים דיווחו על רחפן לא מזוהה שנצפה מעל הכפר',
            fullText: 'תושבי בית ליקיא דיווחו על רחפן לא מזוהה שנצפה מעל הכפר בשעות הבוקר המוקדמות. ככל הנראה מדובר ברחפן צבאי.',
            source: 'beit_liqya',
            urgency: 2,
            urgencyLabel: 'חלש',
            timestamp: now - (8 * hour),
            coordinates: { lat: 31.833, lon: 35.080 },
            matchedLocations: ['Beit Liqya'],
            matchedKeywords: ['רחפן']
        },
        {
            title: 'פעילות שגרתית - מחסום מכבים',
            snippet: 'עיכובים במעבר מחסום מכבים בעקבות בדיקות מוגברות',
            fullText: 'בדיקות מוגברות במחסום מכבים הובילו לעיכובים של עד 30 דקות. הפעילות בוצעה בעקבות הנחיה מודיעינית כללית.',
            source: 'google-news',
            urgency: 2,
            urgencyLabel: 'חלש',
            timestamp: now - (10 * hour),
            coordinates: { lat: 31.850, lon: 35.050 },
            matchedLocations: ['Maccabim CP'],
            matchedKeywords: ['מחסום', 'בדיקות']
        },
        {
            title: 'בצלם: תיעוד פעילות צבאית ברנתיס',
            snippet: 'פעילי ארגון בצלם תיעדו פעילות צבאית בכפר רנתיס',
            fullText: 'פעילי ארגון בצלם ופעילי שמאל בינלאומיים תיעדו בוידאו פעילות צבאית שגרתית בכפר רנתיס. התיעוד הופץ ברשתות החברתיות.',
            source: 'google-news',
            urgency: 3,
            urgencyLabel: 'בינוני',
            timestamp: now - (14 * hour),
            coordinates: { lat: 31.815, lon: 35.060 },
            matchedLocations: ['Rantis'],
            matchedKeywords: ['בצלם', 'פעילי שמאל']
        },
        {
            title: 'ניסיון חדירת גדר באזור קיבא',
            snippet: 'חיישני הגדר איתרו ניסיון חדירה בגזרת קיבא. כוחות הוזנקו.',
            fullText: 'חיישני גדר ההפרדה איתרו ניסיון חדירה בגזרת הכפר קיבא. כוחות צה"ל הוזנקו למקום. לא אותרו חשודים. ככל הנראה מדובר בבעל חיים.',
            source: 'deiribzi',
            urgency: 3,
            urgencyLabel: 'בינוני',
            timestamp: now - (18 * hour),
            coordinates: { lat: 31.810, lon: 35.090 },
            matchedLocations: ['Qibya'],
            matchedKeywords: ['חדירה', 'גדר']
        },
    ];

    // Load demo data
    const demoNews = {};
    demoItems.forEach((item, i) => {
        demoNews['demo-' + i] = item;
    });

    newsData = demoNews;
    allNewsData = { ...allNewsData, ...demoNews };

    // Demo summary
    summaryData = {
        summary: '📊 סיכום מצב גזרה 443:\n\nבשעות האחרונות נרשמה עלייה בפעילות בגזרה. אירוע הירי בבית עור א-תחתא הוא האירוע החמור ביותר. נרשמו מספר מוקדי חיכוך נוספים: חסימת כביש 443 באזור ספא, השלכת אבנים בצומת בית חורון, ועימות בבית סירא.\n\nפעילות אנרכיסטים: הפגנה שבועית בבילעין עם פעילי ISM. תיעוד בצלם ברנתיס.\n\n⚠️ המלצות:\n• הגברת כוננות באזור בית עור - כביש 443\n• סיור מוגבר ספא-בית סירא\n• מעקב אחר פעילות אנרכיסטים בבילעין',
        aiProvider: 'Gemini',
        generatedAt: now - (15 * 60000)
    };

    // Demo metadata
    metaData = { lastRun: now - (3 * 60000) };

    renderAll();

    // Start 60s countdown
    demoCountdown = 60;
    updateDemoButton();
    demoTimer = setInterval(() => {
        demoCountdown--;
        updateDemoButton();
        if (demoCountdown <= 0) {
            exitDemoMode();
        }
    }, 1000);
}

function updateDemoButton() {
    const btn = document.querySelector('[onclick="loadDemoData()"]');
    if (!btn) return;
    btn.style.color = 'var(--green)';
    btn.style.borderColor = 'var(--green)';
    btn.innerHTML = `<span class="btn-icon">&#10003;</span><span>הדגמה פעילה ${demoCountdown}s</span>`;
}

function exitDemoMode() {
    const btn = document.querySelector('[onclick="loadDemoData()"]');
    isDemoMode = false;
    if (demoTimer) { clearInterval(demoTimer); demoTimer = null; }
    newsData = realNewsData;
    allNewsData = realAllNewsData;
    summaryData = realSummaryData;
    metaData = realMetaData;
    renderAll();
    if (btn) {
        btn.style.color = 'var(--yellow)';
        btn.style.borderColor = 'var(--yellow-dim)';
        btn.innerHTML = '<span class="btn-icon">&#9881;</span><span>הדגמה</span>';
    }
}

// ═══════ INIT ═══════
document.addEventListener('DOMContentLoaded', () => {
    try { updateClock(); } catch(e) { console.error('Clock init error:', e); }
    setInterval(() => { try { updateClock(); } catch(e) {} }, 1000);

    try {
        if (typeof L !== 'undefined') {
            initMap();
        } else {
            console.error('Leaflet not loaded');
            document.getElementById('map').innerHTML = '<div style="color:#ff0040;padding:20px;text-align:center;">MAP: Leaflet loading...</div>';
            // Retry after 2 seconds
            setTimeout(() => {
                try { if (typeof L !== 'undefined') initMap(); } catch(e) { console.error('Map retry error:', e); }
            }, 2000);
        }
    } catch(e) { console.error('Map init error:', e); }

    try { fetchData(); } catch(e) { console.error('Fetch init error:', e); }
    try { startRefreshCycle(); } catch(e) { console.error('Refresh init error:', e); }
});
</script>
</body>
</html>
